
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for vrAnalysis - Virtual Reality Analysis Package">
      
      
        <meta name="author" content="Andrew Landau">
      
      
        <link rel="canonical" href="https://landoskape.github.io/vrAnalysis/api/registration/">
      
      
        <link rel="prev" href="../database/">
      
      
        <link rel="next" href="../processors/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>registration - vrAnalysis Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#registration-api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="vrAnalysis Documentation" class="md-header__button md-logo" aria-label="vrAnalysis Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            vrAnalysis Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              registration
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/landoskape/vrAnalysis" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    landoskape/vrAnalysis
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../installation/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../overview/" class="md-tabs__link">
        
  
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../workflows/" class="md-tabs__link">
          
  
  
  Workflows

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../sessions/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/" class="md-tabs__link">
          
  
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="vrAnalysis Documentation" class="md-nav__button md-logo" aria-label="vrAnalysis Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    vrAnalysis Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/landoskape/vrAnalysis" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    landoskape/vrAnalysis
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Workflows
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workflows
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflows/registration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Registration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sessions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    sessions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../b2session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    b2sessions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    database
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    registration
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    registration
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vrAnalysis.registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        registration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="registration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        B2Registration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="B2Registration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.convert_dense" class="md-nav__link">
    <span class="md-ellipsis">
      
        convert_dense
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.convert_rotary_encoder_to_position" class="md-nav__link">
    <span class="md-ellipsis">
      
        convert_rotary_encoder_to_position
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.create_index" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.do_preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      
        do_preprocessing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.get_timeline_var" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_timeline_var
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.get_vr_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vr_data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.load_behavior_structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_behavior_structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.load_timeline_structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_timeline_structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_behavior_to_imaging" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_behavior_to_imaging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_facecam" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_facecam
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_imaging" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_imaging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_red_cells" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_red_cells
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_timeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_timeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.register" class="md-nav__link">
    <span class="md-ellipsis">
      
        register
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.timeline_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        timeline_inputs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing" class="md-nav__link">
    <span class="md-ellipsis">
      
        RedCellProcessing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RedCellProcessing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.centered_mask_stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        centered_mask_stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.centered_reference_stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        centered_reference_stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.compute_corr" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_corr
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.compute_dot" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_dot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.compute_volume" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_volume
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.create_centered_axis" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_centered_axis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.cropped_phase_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      
        cropped_phase_correlation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.get_roi_centroid" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_roi_centroid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.get_roi_in_plane_idx" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_roi_in_plane_idx
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.get_roi_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_roi_range
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.getxref" class="md-nav__link">
    <span class="md-ellipsis">
      
        getxref
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.getyref" class="md-nav__link">
    <span class="md-ellipsis">
      
        getyref
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.load_reference_and_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_reference_and_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.one_name_feature_cutoffs" class="md-nav__link">
    <span class="md-ellipsis">
      
        one_name_feature_cutoffs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.update_from_session" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_from_session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.update_red_idx" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_red_idx
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        behavior
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="behavior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.BEHAVIOR_PROCESSING" class="md-nav__link">
    <span class="md-ellipsis">
      
        BEHAVIOR_PROCESSING
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.cr_hippocannula_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        cr_hippocannula_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.register_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        register_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.standard_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        standard_behavior
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrAnalysis.registration.oasis" class="md-nav__link">
    <span class="md-ellipsis">
      
        oasis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="oasis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.oasis.oasis_deconvolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        oasis_deconvolution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    processors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/session_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Session Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vrAnalysis.registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        registration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="registration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        B2Registration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="B2Registration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.convert_dense" class="md-nav__link">
    <span class="md-ellipsis">
      
        convert_dense
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.convert_rotary_encoder_to_position" class="md-nav__link">
    <span class="md-ellipsis">
      
        convert_rotary_encoder_to_position
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.create_index" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.do_preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      
        do_preprocessing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.get_timeline_var" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_timeline_var
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.get_vr_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vr_data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.load_behavior_structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_behavior_structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.load_timeline_structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_timeline_structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_behavior_to_imaging" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_behavior_to_imaging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_facecam" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_facecam
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_imaging" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_imaging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_red_cells" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_red_cells
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.process_timeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_timeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.register" class="md-nav__link">
    <span class="md-ellipsis">
      
        register
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.B2Registration.timeline_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        timeline_inputs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing" class="md-nav__link">
    <span class="md-ellipsis">
      
        RedCellProcessing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RedCellProcessing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.centered_mask_stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        centered_mask_stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.centered_reference_stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        centered_reference_stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.compute_corr" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_corr
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.compute_dot" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_dot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.compute_volume" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_volume
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.create_centered_axis" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_centered_axis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.cropped_phase_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      
        cropped_phase_correlation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.get_roi_centroid" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_roi_centroid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.get_roi_in_plane_idx" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_roi_in_plane_idx
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.get_roi_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_roi_range
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.getxref" class="md-nav__link">
    <span class="md-ellipsis">
      
        getxref
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.getyref" class="md-nav__link">
    <span class="md-ellipsis">
      
        getyref
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.load_reference_and_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_reference_and_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.one_name_feature_cutoffs" class="md-nav__link">
    <span class="md-ellipsis">
      
        one_name_feature_cutoffs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.update_from_session" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_from_session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.RedCellProcessing.update_red_idx" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_red_idx
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        behavior
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="behavior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.BEHAVIOR_PROCESSING" class="md-nav__link">
    <span class="md-ellipsis">
      
        BEHAVIOR_PROCESSING
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.cr_hippocannula_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        cr_hippocannula_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.register_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        register_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.behavior.standard_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        standard_behavior
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrAnalysis.registration.oasis" class="md-nav__link">
    <span class="md-ellipsis">
      
        oasis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="oasis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrAnalysis.registration.oasis.oasis_deconvolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        oasis_deconvolution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="registration-api-reference">Registration API Reference<a class="headerlink" href="#registration-api-reference" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<h2 id="vrAnalysis.registration" class="doc doc-heading">
            <code>registration</code>


<a href="#vrAnalysis.registration" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="vrAnalysis.registration.B2Registration" class="doc doc-heading">
            <code>B2Registration</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#vrAnalysis.registration.B2Registration" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="B2Session


  
      dataclass
   (vrAnalysis.sessions.b2session.B2Session)" href="../b2session/#vrAnalysis.sessions.B2Session">B2Session</a></code></p>



        <p>Registration class for processing B2 (vrControl) session data.</p>
<p>This class handles the preprocessing and registration of behavioral and
imaging data from vrControl experiments. It processes timeline data,
behavioral data, imaging data (suite2p outputs), red cell identification,
and creates mappings between behavioral and imaging data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mouse_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the mouse.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>date_string</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Date string in format "YYYY-MM-DD".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Session identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>opts</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2RegistrationOpts


  
      dataclass
   (vrAnalysis.sessions.b2session.B2RegistrationOpts)" href="../b2session/#vrAnalysis.sessions.b2session.B2RegistrationOpts">B2RegistrationOpts</a> or <span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Registration options. If a dict, will be converted to B2RegistrationOpts.
Default is B2RegistrationOpts().</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2RegistrationOpts


  
      dataclass
   (vrAnalysis.sessions.b2session.B2RegistrationOpts)" href="../b2session/#vrAnalysis.sessions.b2session.B2RegistrationOpts">B2RegistrationOpts</a>()</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.B2Registration.opts">opts</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2RegistrationOpts


  
      dataclass
   (vrAnalysis.sessions.b2session.B2RegistrationOpts)" href="../b2session/#vrAnalysis.sessions.b2session.B2RegistrationOpts">B2RegistrationOpts</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Registration options.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.B2Registration.tl_file">tl_file</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeline data loaded from Timeline.mat file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.B2Registration.vr_file">vr_file</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Behavioral data loaded from VRBehavior_trial.mat file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If session directory does not exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="k">class</span><span class="w"> </span><span class="nc">B2Registration</span><span class="p">(</span><span class="n">B2Session</span><span class="p">):</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    Registration class for processing B2 (vrControl) session data.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    This class handles the preprocessing and registration of behavioral and</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    imaging data from vrControl experiments. It processes timeline data,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    behavioral data, imaging data (suite2p outputs), red cell identification,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    and creates mappings between behavioral and imaging data.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    mouse_name : str</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        Name of the mouse.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    date_string : str</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        Date string in format &quot;YYYY-MM-DD&quot;.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    session_id : str</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        Session identifier.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    opts : B2RegistrationOpts or dict, optional</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        Registration options. If a dict, will be converted to B2RegistrationOpts.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        Default is B2RegistrationOpts().</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    Attributes</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    opts : B2RegistrationOpts</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        Registration options.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    tl_file : dict</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        Timeline data loaded from Timeline.mat file.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    vr_file : dict</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        Behavioral data loaded from VRBehavior_trial.mat file.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    ------</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    ValueError</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        If session directory does not exist.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="n">_for_registration</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">mouse_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">date_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">opts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">B2RegistrationOpts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">B2RegistrationOpts</span><span class="p">(),</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="p">):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        Initialize B2Registration object.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        mouse_name : str</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">            Name of the mouse.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        date_string : str</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">            Date string in format &quot;YYYY-MM-DD&quot;.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        session_id : str</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">            Session identifier.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        opts : B2RegistrationOpts or dict, optional</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">            Registration options. If a dict, will be converted to B2RegistrationOpts.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">            Default is B2RegistrationOpts().</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">        ------</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        ValueError</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">            If session directory does not exist.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mouse_name</span><span class="p">,</span> <span class="n">date_string</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">B2RegistrationOpts</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">elif</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">B2RegistrationOpts</span><span class="p">(</span><span class="o">**</span><span class="n">asdict</span><span class="p">(</span><span class="n">opts</span><span class="p">))</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">B2RegistrationOpts</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;opts must be B2RegistrationOpts, a dataclass, or a mapping; got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session directory does not exist for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">one_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_additional_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        Override to skip loading registered data.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        Registration objects produce registered data rather than load it,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        so we skip the parent&#39;s _additional_loading() which tries to load</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">        from saved JSON files.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        -----</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        This method intentionally does nothing. Registration objects create</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        data rather than loading pre-existing registered data.</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">pass</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        Register the session by running all preprocessing steps.</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        This is the main entry point for registration. It runs all preprocessing</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        steps (timeline, behavior, imaging, red cells, facecam, behavior-to-imaging)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        and saves session parameters.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        See Also</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        --------</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        do_preprocessing : Run all preprocessing steps.</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        save_session_prms : Save session parameters to oneData.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">do_preprocessing</span><span class="p">()</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_session_prms</span><span class="p">()</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">do_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        Run all preprocessing steps for the session.</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        Processes timeline data, behavioral data, imaging data, red cell</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        identification, facecam data (placeholder), and creates mappings</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        between behavioral and imaging data.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        -----</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        Processing steps are run in order:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        1. Timeline processing</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        2. Behavior processing</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        3. Imaging processing</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        4. Red cell processing (if enabled)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        5. Facecam processing (not yet implemented)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        6. Behavior-to-imaging mapping</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">clearOne</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">clear_one_data</span><span class="p">(</span><span class="n">certainty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_timeline</span><span class="p">()</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_behavior</span><span class="p">()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_imaging</span><span class="p">()</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_red_cells</span><span class="p">()</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_facecam</span><span class="p">()</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_behavior_to_imaging</span><span class="p">()</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="c1"># --------------------------------------------------------------- preprocessing methods ------------------------------------------------------------</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_timeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">        Process timeline data from rigbox.</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">        Extracts timestamps, rotary encoder position, lick times, reward times,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">        and trial start times from the Timeline.mat file. Processes photodiode</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">        signals to align trial starts with imaging frames.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">        -----</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        This method:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        - Loads timeline structure from Timeline.mat</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        - Converts rotary encoder to position</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        - Detects licks and rewards</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">        - Processes photodiode signal to find trial start frames</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">        - Saves timeline data to oneData</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="c1"># load these files for raw behavioral &amp; timeline data</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_timeline_structure</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_behavior_structure</span><span class="p">()</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="c1"># get time stamps, photodiode, trial start and end times, room position, lick times, trial idx, visual data visible</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="n">mpepStartTimes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="k">for</span> <span class="n">mt</span><span class="p">,</span> <span class="n">me</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;mpepUDPTimes&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;mpepUDPEvents&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="k">if</span> <span class="s2">&quot;TrialStart&quot;</span> <span class="ow">in</span> <span class="n">me</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                    <span class="n">mpepStartTimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="k">elif</span> <span class="s2">&quot;StimStart&quot;</span> <span class="ow">in</span> <span class="n">me</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                    <span class="n">mpepStartTimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">mpepStartTimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mpepStartTimes</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;timestamps&quot;</span><span class="p">)</span>  <span class="c1"># load timestamps</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="c1"># Get rotary position -- (load timeline measurement of rotary encoder, which is a circular position counter, use vrExperiment function to convert to a running measurement of position)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">rotaryEncoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;rotaryEncoder&quot;</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">rotaryPosition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_rotary_encoder_to_position</span><span class="p">(</span><span class="n">rotaryEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">])</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="c1"># Get Licks (uses an edge counter)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">lickDetector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;lickDetector&quot;</span><span class="p">)</span>  <span class="c1"># load lick detector copy</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">lickSamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">diffsame</span><span class="p">(</span><span class="n">lickDetector</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>  <span class="c1"># timeline samples of lick times</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="c1"># Get Reward Commands (measures voltage of output -- assume it&#39;s either low or high)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">rewardCommand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;rewardCommand&quot;</span><span class="p">)</span>  <span class="c1"># load reward command signal</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">rewardCommand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rewardCommand</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rewardCommand</span><span class="p">))</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">rewardSamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">diffsame</span><span class="p">(</span><span class="n">rewardCommand</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>  <span class="c1"># timeline samples when reward was delivered</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="c1"># Now process photodiode signal</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">photodiode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;photoDiode&quot;</span><span class="p">)</span>  <span class="c1"># load lick detector copy</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="c1"># Remove any slow trends</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">pdDetrend</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">photodiode</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">pdDetrend</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdDetrend</span> <span class="o">-</span> <span class="n">pdDetrend</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">pdDetrend</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="c1"># median filter and take smooth derivative</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">hfpd</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">refreshRate</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># hz</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="n">refreshSamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">refreshRate</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)))</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">pdMedFilt</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">pdDetrend</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">refreshSamples</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">pdDerivative</span><span class="p">,</span> <span class="n">pdIndex</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">fivePointDer</span><span class="p">(</span><span class="n">pdMedFilt</span><span class="p">,</span> <span class="n">hfpd</span><span class="p">,</span> <span class="n">returnIndex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="n">pdDerivative</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">pdDerivative</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="n">pdDerTime</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">pdIndex</span><span class="p">]</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="c1"># find upward and downward peaks, not perfect but in practice close enough</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="n">locUp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">pdDerivative</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">refreshSamples</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="n">locDn</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">pdDerivative</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">refreshSamples</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">flipTimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pdDerTime</span><span class="p">[</span><span class="n">locUp</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">pdDerTime</span><span class="p">[</span><span class="n">locDn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">flipValue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locUp</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locDn</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">flipSortIdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">flipTimes</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">flipTimes</span> <span class="o">=</span> <span class="n">flipTimes</span><span class="p">[</span><span class="n">flipSortIdx</span><span class="p">]</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">flipValue</span> <span class="o">=</span> <span class="n">flipValue</span><span class="p">[</span><span class="n">flipSortIdx</span><span class="p">]</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="c1"># Naive Method (just look for flips before and after trialstart/trialend mpep message:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="c1"># A sophisticated message uses the time of the photodiode ramps, but those are really just for safety and rare manual curation...</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">firstFlipIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flipTimes</span> <span class="o">&gt;=</span> <span class="n">mpepStart</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">mpepStart</span> <span class="ow">in</span> <span class="n">mpepStartTimes</span><span class="p">])</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">startTrialIndex</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">nearestpoint</span><span class="p">(</span><span class="n">flipTimes</span><span class="p">[</span><span class="n">firstFlipIndex</span><span class="p">],</span> <span class="n">timestamps</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># returns frame index of first photodiode flip in each trial</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="c1"># Check that first flip is always down -- all of the vrControl code prepares trials in this way</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2022-08-30&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">):</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="c1"># But it didn&#39;t prepare it this way before august 30th :(</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flipValue</span><span class="p">[</span><span class="n">firstFlipIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sessionPrint</span><span class="p">()</span><span class="si">}</span><span class="s2">, first flips in trial are not all down!!&quot;</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="c1"># Check shapes of timeline arrays</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">assert</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;timelineTimestamps is not a 1-d array!&quot;</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="k">assert</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">rotaryPosition</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;timeline timestamps and rotary position arrays do not have the same shape!&quot;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="c1"># Save timeline oneData</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="s2">&quot;wheelPosition.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">rotaryPosition</span><span class="p">,</span> <span class="s2">&quot;wheelPosition.position&quot;</span><span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">lickSamples</span><span class="p">],</span> <span class="s2">&quot;licks.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">rewardSamples</span><span class="p">],</span> <span class="s2">&quot;rewards.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">startTrialIndex</span><span class="p">],</span> <span class="s2">&quot;trials.startTimes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;timeline&quot;</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        Process behavioral data from vrControl.</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">        Processes behavioral data using the appropriate behavior processing</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        function based on the vrBehaviorVersion option. Extracts trial-level</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        and sample-level behavioral data and aligns timestamps to the timeline.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        See Also</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        --------</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        register_behavior : Dispatcher function for behavior processing.</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="bp">self</span> <span class="o">=</span> <span class="n">register_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">vrBehaviorVersion</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="c1"># Confirm that vrBehavior has been processed</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;vrBehavior&quot;</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">        Process imaging data from suite2p outputs.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        Loads suite2p outputs, identifies available planes and outputs,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        handles frame count mismatches between suite2p and timeline,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">        optionally recomputes deconvolution using OASIS, and saves imaging</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        data to oneData format.</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">        ------</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        ValueError</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">            If imaging is requested but suite2p directory does not exist, or</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">            if required suite2p outputs are missing, or if frame count</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">            mismatches cannot be resolved.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">        -----</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">        This method:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">        - Identifies planes and available suite2p outputs</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        - Checks for required outputs (stat, ops, F, Fneu, iscell, spks)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">        - Handles frame count mismatches between suite2p and timeline</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        - Optionally recomputes deconvolution using OASIS</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">        - Saves imaging data to oneData</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">imaging</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, imaging setting set to False in opts[&#39;imaging&#39;]. Skipping image processing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2p_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, suite2p processing was requested but suite2p directory does not exist.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="c1"># identifies which planes were processed through suite2p (assume that those are all available planes)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="c1"># identifies which s2p outputs are available from each plane</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">plane</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2p_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;plane*/&quot;</span><span class="p">)])</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;planeIDs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">planeName</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span> <span class="k">for</span> <span class="n">planeName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">)])</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="n">npysInPlanes</span> <span class="o">=</span> <span class="p">[[</span><span class="n">npy</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">npy</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">s2p_path</span> <span class="o">/</span> <span class="n">planeName</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.npy&quot;</span><span class="p">))]</span> <span class="k">for</span> <span class="n">planeName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">commonNPYs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">npy</span><span class="p">)</span> <span class="k">for</span> <span class="n">npy</span> <span class="ow">in</span> <span class="n">npysInPlanes</span><span class="p">]))</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="n">unionNPYs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">npy</span><span class="p">)</span> <span class="k">for</span> <span class="n">npy</span> <span class="ow">in</span> <span class="n">npysInPlanes</span><span class="p">]))</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">commonNPYs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">unionNPYs</span><span class="p">):</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="sa">f</span><span class="s2">&quot;The following npy files are present in some but not all plane folders within session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unionNPYs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">commonNPYs</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each plane folder contains the following npy files: </span><span class="si">{</span><span class="n">commonNPYs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">,</span> <span class="n">commonNPYs</span><span class="p">)</span>  <span class="c1"># a list of npy files available in each plane folder</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="c1"># required variables (anything else is either optional or can be computed independently)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="s2">&quot;ops&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;Fneu&quot;</span><span class="p">,</span> <span class="s2">&quot;iscell&quot;</span><span class="p">]</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">oasis</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="c1"># add deconvolved spikes to required variable if we aren&#39;t recomputing it here</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;spks&quot;</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="k">for</span> <span class="n">varName</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="k">assert</span> <span class="n">varName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2"> is missing </span><span class="si">{</span><span class="n">varName</span><span class="si">}</span><span class="s2"> in at least one suite2p folder!&quot;</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="c1"># get number of ROIs in each plane</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">iscell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">iscell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;iscell&quot;</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="c1"># get number of frames in each plane (might be different!)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">F</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="n">assert_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The frame count in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2"> varies by more than 1 frame! (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;framePerPlane&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">assert_msg</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numROIs&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)))</span>  <span class="c1"># number of ROIs in session</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="c1"># number of frames to use when retrieving imaging data (might be overwritten to something smaller if timeline handled improperly)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="c1"># Get timeline sample corresponding to each imaging volume</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">timeline_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;wheelPosition.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">changeFrames</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;neuralFrames&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeIDs&quot;</span><span class="p">)))),</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">changeFrames</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># TTLs for each volume (increments by 1 for each plane)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">timeline_timestamps</span><span class="p">[</span><span class="n">frame_samples</span><span class="p">]</span>  <span class="c1"># get timelineTimestamps of each imaging volume</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="c1"># Handle mismatch between number of imaging frames saved by scanImage (and propagated through suite2p), and between timeline&#39;s measurement of the scanImage frame counter</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">):</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">):</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                <span class="c1"># If frame_to_time had one more frame, just trim it and assume everything is fine. This happens when a new volume was started but not finished, so does not required communication to user.</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">frame_samples</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">frame_to_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">):</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                    <span class="s2">&quot;frame_to_time had 2 more than suite2p output. This happens sometimes. I don&#39;t like it. I think it&#39;s because scanimage sends a TTL before starting the frame&quot;</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                <span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">frame_samples</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">frame_to_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="c1"># If frameSamples has too few frames, it&#39;s possible that the scanImage signal to timeline was broken but scanImage still continued normally.</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="n">numMissing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_samples</span><span class="p">)</span>  <span class="c1"># measure number of missing frames</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                <span class="k">if</span> <span class="n">numMissing</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                    <span class="c1"># If frameSamples had many more frames, generate an error -- something went wrong that needs manual inspection</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                    <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                        <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, frameSamples has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_samples</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements, but </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;numFrames&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames were reported in suite2p. Cannot resolve.&quot;</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>                    <span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot fix mismatches when suite2p data is missing!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                <span class="c1"># It&#39;s possible that the scanImage signal to timeline was broken but scanImage still continued normally.</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                <span class="k">if</span> <span class="n">numMissing</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                    <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                        <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, more than one frameSamples sample was missing. Consider using tiff timelineTimestamps to reproduce accurately.&quot;</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                    <span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                    <span class="p">(</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                        <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, frameSamples has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_samples</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements, but </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;numFrames&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames were saved by suite2p. &quot;</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                        <span class="s2">&quot;Will extend frameSamples using the typical sampling rate and nearestpoint algorithm.&quot;</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                    <span class="p">)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                <span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                <span class="c1"># If frame_to_time difference vector is consistent within 1%, then use mean (which is a little more accurate), otherwise use median</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">timeline_timestamps</span><span class="p">[</span><span class="n">frame_samples</span><span class="p">]</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                <span class="n">medianFramePeriod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))</span>  <span class="c1"># measure median sample period</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                <span class="n">consistentFrames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">medianFramePeriod</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.01</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="p">)</span>  <span class="c1"># True if all frames take within 1% of median frame period</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                <span class="k">if</span> <span class="n">consistentFrames</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                    <span class="n">samplePeriod_f2t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                    <span class="n">samplePeriod_f2t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="n">appendFrames</span> <span class="o">=</span> <span class="n">frame_to_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">samplePeriod_f2t</span> <span class="o">*</span> <span class="p">(</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numMissing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="p">)</span>  <span class="c1"># add elements to frame_to_time, assume sampling rate was perfect</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">frame_to_time</span><span class="p">,</span> <span class="n">appendFrames</span><span class="p">))</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">nearestpoint</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">,</span> <span class="n">timeline_timestamps</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="c1"># average percentage difference between all samples differences and median -- just a useful metric to be saved --</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="s2">&quot;samplingDeviationMedianPercentError&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))))))</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="s2">&quot;samplingDeviationMaximumPercentError&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))))))</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="c1"># recompute deconvolution if requested</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="n">spks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;spks&quot;</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">oasis</span><span class="p">:</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="c1"># set parameters for oasis and get corrected fluorescence traces</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">tau</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="n">fcorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadfcorr</span><span class="p">(</span><span class="n">try_from_one</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">oasis_deconvolution</span><span class="p">(</span><span class="n">fcorr</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="n">ospks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="c1"># Check that the shape is correct</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, oasis was run and did not produce the same shaped array as suite2p spks...&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>            <span class="k">assert</span> <span class="n">ospks</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">spks</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">msg</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="c1"># save onedata (no assertions needed, loadS2P() handles shape checks and this function already handled any mismatch between frameSamples and suite2p output</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">,</span> <span class="s2">&quot;mpci.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transpose&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpci.roiActivityF&quot;</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;Fneu&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transpose&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpci.roiNeuropilActivityF&quot;</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;spks&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transpose&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpci.roiActivityDeconvolved&quot;</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="k">if</span> <span class="s2">&quot;redcell&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">):</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;redcell&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;idx_column1&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpciROIs.redS2P&quot;</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;iscell&quot;</span><span class="p">),</span> <span class="s2">&quot;mpciROIs.isCell&quot;</span><span class="p">)</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_roi_position</span><span class="p">(),</span> <span class="s2">&quot;mpciROIs.stackPosition&quot;</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">oasis</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">ospks</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s2">&quot;mpci.roiActivityDeconvolvedOasis&quot;</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;imaging&quot;</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_facecam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="sd">        Process facecam data.</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">        Placeholder for facecam preprocessing. Not yet implemented.</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">        -----</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">        This method currently only prints a message indicating that facecam</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        preprocessing has not been implemented yet.</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Facecam preprocessing has not been coded yet!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_behavior_to_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">        Create mapping from behavioral frames to imaging frames.</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        Computes the nearest imaging frame for each behavioral sample and</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">        saves the mapping to oneData.</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><span class="sd">        -----</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><span class="sd">        This method is skipped if imaging is disabled in opts. The mapping</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="sd">        is saved as &quot;positionTracking.mpci&quot; in oneData.</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">imaging</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, imaging setting set to False in opts[&#39;imaging&#39;]. Skipping behavior2imaging processing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>        <span class="c1"># compute translation mapping from behave frames to imaging frames</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="n">idx_behave_to_frame</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">nearestpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;positionTracking.times&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpci.times&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">idx_behave_to_frame</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;positionTracking.mpci&quot;</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_red_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">        Process red cell features for identification.</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">        Computes red cell features (dot product, Pearson correlation, phase</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">        correlation) using RedCellProcessing and saves them to oneData.</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">        Initializes red cell index and manual assignment arrays.</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><span class="sd">        -----</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="sd">        This method is skipped if imaging or redCellProcessing is disabled in opts,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">        or if redcell output is not available in suite2p. The computed features</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">        are saved to oneData for later use in red cell identification.</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">imaging</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">redCellProcessing</span><span class="p">):</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>            <span class="k">return</span>  <span class="c1"># if not requested, skip function</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="c1"># if imaging was processed and redCellProcessing was requested, then try to preprocess red cell features</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="k">if</span> <span class="s2">&quot;redcell&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">):</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, &#39;redcell&#39; is not an available suite2p output, although &#39;redCellProcessing&#39; was requested.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="k">return</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="c1"># create RedCellProcessing object</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="c1"># b2session_of_self = B2Session.create(self.mouse_name, self.date, self.session_id, for_registration=True)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="n">red_cell_processing</span> <span class="o">=</span> <span class="n">RedCellProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="c1"># compute red-features</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="n">dot_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lowcut&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;highcut&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;fs&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">}</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="n">corr_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;lowcut&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;highcut&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;fs&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">}</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>        <span class="n">phase_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span> <span class="s2">&quot;winFunc&quot;</span><span class="p">:</span> <span class="s2">&quot;hamming&quot;</span><span class="p">}</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing red cell features for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">... (usually takes 10-20 seconds)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="n">dot_product</span> <span class="o">=</span> <span class="n">red_cell_processing</span><span class="o">.</span><span class="n">compute_dot</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">dot_parameters</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">red_cell_processing</span><span class="o">.</span><span class="n">compute_corr</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_parameters</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="n">phase_corr</span> <span class="o">=</span> <span class="n">red_cell_processing</span><span class="o">.</span><span class="n">cropped_phase_correlation</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">phase_parameters</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="c1"># initialize annotations</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numROIs&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">),</span> <span class="s2">&quot;mpciROIs.redCellIdx&quot;</span><span class="p">)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numROIs&quot;</span><span class="p">)),</span> <span class="kc">False</span><span class="p">),</span> <span class="s2">&quot;mpciROIs.redCellManualAssignments&quot;</span><span class="p">)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="c1"># save oneData</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">dot_product</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redDotProduct&quot;</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">corr_coeff</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redPearson&quot;</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">phase_corr</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redPhaseCorrelation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dot_parameters</span><span class="p">),</span> <span class="s2">&quot;parametersRedDotProduct.keyValuePairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corr_parameters</span><span class="p">),</span> <span class="s2">&quot;parametersRedPearson.keyValuePairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_parameters</span><span class="p">),</span> <span class="s2">&quot;parametersRedPhaseCorrelation.keyValuePairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="c1"># -------------------------------------- methods for handling timeline data produced by rigbox ------------------------------------------------------------</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_timeline_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">        Load timeline structure from Timeline.mat file.</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">        Loads the Timeline.mat file produced by rigbox and stores it in</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">        self.tl_file. The file is expected to be named</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">        &quot;{date}_{session_id}_{mouse_name}_Timeline.mat&quot;.</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">        -----</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">        The timeline file contains raw DAQ data, timestamps, and hardware</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">        input measurements from the experimental rig.</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="n">tl_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse_name</span><span class="si">}</span><span class="s2">_Timeline.mat&quot;</span>  <span class="c1"># timeline.mat file name</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span> <span class="o">=</span> <span class="n">scio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">tl_file_name</span><span class="p">,</span> <span class="n">simplify_cells</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;Timeline&quot;</span><span class="p">]</span>  <span class="c1"># load matlab structure</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">timeline_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_timestamps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">        Get list of available timeline input names.</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">        ignore_timestamps : bool, optional</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">            If True, return only hardware input names. If False, include</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">            &quot;timestamps&quot; as the first element. Default is False.</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">        -------</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">        list of str</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">            List of timeline input names.</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tl_file&quot;</span><span class="p">):</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_timeline_structure</span><span class="p">()</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>        <span class="n">hw_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">hwInput</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hwInput</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;hw&quot;</span><span class="p">][</span><span class="s2">&quot;inputs&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="k">if</span> <span class="n">ignore_timestamps</span><span class="p">:</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>            <span class="k">return</span> <span class="n">hw_inputs</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">hw_inputs</span><span class="p">]</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_timeline_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">        Get a timeline variable by name.</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">        var_name : str</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="sd">            Name of the timeline variable to retrieve. Can be &quot;timestamps&quot;</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">            or any hardware input name.</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">        -------</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">            Timeline variable data as a 1D array.</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">        ------</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">        AssertionError</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">            If var_name is not a valid timeline variable name.</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tl_file&quot;</span><span class="p">):</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_timeline_structure</span><span class="p">()</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;rawDAQTimestamps&quot;</span><span class="p">]</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="n">inputNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeline_inputs</span><span class="p">(</span><span class="n">ignore_timestamps</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>            <span class="k">assert</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">inputNames</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> is not a tl_file in session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;rawDAQData&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">inputName</span> <span class="o">==</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">inputName</span> <span class="ow">in</span> <span class="n">inputNames</span><span class="p">])[</span><span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_rotary_encoder_to_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rotaryEncoder</span><span class="p">,</span> <span class="n">rigInfo</span><span class="p">):</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">        Convert rotary encoder counts to position in centimeters.</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">        The rotary encoder is a counter with a large range that sometimes</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="sd">        wraps around. This method handles wrap-around, computes cumulative</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="sd">        movement, and scales to centimeters.</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><span class="sd">        rotaryEncoder : np.ndarray</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a><span class="sd">            Rotary encoder counts from timeline.</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a><span class="sd">        rigInfo : DefaultRigInfo or similar</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="sd">            Rig information containing rotary encoder parameters.</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">        -------</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="sd">            Position in centimeters, shape (num_samples,).</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>        <span class="c1"># rotary encoder is a counter with a big range that sometimes flips around it&#39;s axis</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>        <span class="c1"># first get changes in encoder position, fix any big jumps in value, take the cumulative movement and scale to centimeters</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>        <span class="n">rotary_movement</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">diffsame</span><span class="p">(</span><span class="n">rotaryEncoder</span><span class="p">)</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>        <span class="n">idx_high_values</span> <span class="o">=</span> <span class="n">rotary_movement</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>        <span class="n">idx_low_values</span> <span class="o">=</span> <span class="n">rotary_movement</span> <span class="o">&lt;</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>        <span class="n">rotary_movement</span><span class="p">[</span><span class="n">idx_high_values</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">**</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>        <span class="n">rotary_movement</span><span class="p">[</span><span class="n">idx_low_values</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>        <span class="k">return</span> <span class="n">rigInfo</span><span class="o">.</span><span class="n">rotEncSign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rotary_movement</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rigInfo</span><span class="o">.</span><span class="n">wheelRadius</span><span class="p">)</span> <span class="o">/</span> <span class="n">rigInfo</span><span class="o">.</span><span class="n">wheelToVR</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>    <span class="c1"># -------------------------------------- methods for handling vrBehavior data produced by vrControl ------------------------------------------------------------</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_behavior_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">        Load behavioral structure from VRBehavior_trial.mat file.</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">        Loads the VRBehavior_trial.mat file produced by vrControl and stores</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">        it in self.vr_file. If rigInfo is missing, uses DefaultRigInfo as</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">        a fallback.</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="sd">        -----</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="sd">        The behavior file contains trial-level and sample-level behavioral</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">        data including timestamps, positions, rewards, and licks. The file</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="sd">        is expected to be named</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">        &quot;{date}_{session_id}_{mouse_name}_VRBehavior_trial.mat&quot;.</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>        <span class="n">vr_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse_name</span><span class="si">}</span><span class="s2">_VRBehavior_trial.mat&quot;</span>  <span class="c1"># vrBehavior output file name</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span> <span class="o">=</span> <span class="n">scio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">vr_file_name</span><span class="p">,</span> <span class="n">struct_as_record</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze_me</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="k">if</span> <span class="s2">&quot;rigInfo&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assuming default settings for B2 using `DefaultRigInfo()` in session: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">!!!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultRigInfo</span><span class="p">()</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">],</span> <span class="s2">&quot;rotaryRange&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rotaryRange</span> <span class="o">=</span> <span class="mi">32</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">        Convert sparse or dense array to dense numpy array.</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">        Truncates data to numTrials rows and converts sparse matrices to</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="sd">        dense arrays.</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a><span class="sd">        data : np.ndarray or scipy.sparse.spmatrix</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">            Input data, which may be sparse or dense.</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="sd">        -------</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a><span class="sd">            Dense numpy array, truncated to numTrials rows and squeezed.</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_stamps</span><span class="p">):</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="sd">        Create index arrays for non-zero/non-NaN timestamps per trial.</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="sd">        time_stamps : np.ndarray</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="sd">            Timestamps as (numTrials x numSamples) dense numpy array.</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><span class="sd">        -------</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="sd">        list of np.ndarray</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a><span class="sd">            List of index arrays, one per trial, indicating which samples</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a><span class="sd">            have valid data (non-NaN or non-zero).</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>        <span class="c1"># requires timestamps as (numTrials x numSamples) dense numpy array</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">time_stamps</span><span class="p">)):</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">t</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_stamps</span><span class="p">]</span>  <span class="c1"># in case we have dense timestamps with nans where no data</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_stamps</span><span class="p">]</span>  <span class="c1"># in case we have sparse timestamps with 0s where no data</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_vr_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nzindex</span><span class="p">):</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="sd">        Extract valid data samples using index arrays.</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="sd">        data : np.ndarray</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">            Data array, shape (numTrials, numSamples).</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><span class="sd">        nzindex : list of np.ndarray</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="sd">            List of index arrays, one per trial, indicating valid samples.</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="sd">        -------</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="sd">        list of np.ndarray</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">            List of data arrays, one per trial, containing only valid samples.</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">nz</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">nz</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nzindex</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">mouse_name</span><span class="p">,</span> <span class="n">date_string</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">B2RegistrationOpts</span><span class="p">())</span></code>

<a href="#vrAnalysis.registration.B2Registration.__init__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initialize B2Registration object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mouse_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the mouse.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>date_string</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Date string in format "YYYY-MM-DD".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Session identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>opts</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2RegistrationOpts


  
      dataclass
   (vrAnalysis.sessions.b2session.B2RegistrationOpts)" href="../b2session/#vrAnalysis.sessions.b2session.B2RegistrationOpts">B2RegistrationOpts</a> or <span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Registration options. If a dict, will be converted to B2RegistrationOpts.
Default is B2RegistrationOpts().</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2RegistrationOpts


  
      dataclass
   (vrAnalysis.sessions.b2session.B2RegistrationOpts)" href="../b2session/#vrAnalysis.sessions.b2session.B2RegistrationOpts">B2RegistrationOpts</a>()</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If session directory does not exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">mouse_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">date_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">opts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">B2RegistrationOpts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">B2RegistrationOpts</span><span class="p">(),</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="p">):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    Initialize B2Registration object.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    mouse_name : str</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        Name of the mouse.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    date_string : str</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        Date string in format &quot;YYYY-MM-DD&quot;.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    session_id : str</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        Session identifier.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    opts : B2RegistrationOpts or dict, optional</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        Registration options. If a dict, will be converted to B2RegistrationOpts.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        Default is B2RegistrationOpts().</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    ------</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    ValueError</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        If session directory does not exist.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mouse_name</span><span class="p">,</span> <span class="n">date_string</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">B2RegistrationOpts</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="k">elif</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">B2RegistrationOpts</span><span class="p">(</span><span class="o">**</span><span class="n">asdict</span><span class="p">(</span><span class="n">opts</span><span class="p">))</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">B2RegistrationOpts</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;opts must be B2RegistrationOpts, a dataclass, or a mapping; got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session directory does not exist for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">one_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.convert_dense" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_dense</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.B2Registration.convert_dense" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Convert sparse or dense array to dense numpy array.</p>
<p>Truncates data to numTrials rows and converts sparse matrices to
dense arrays.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <span title="scipy.sparse.spmatrix">spmatrix</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data, which may be sparse or dense.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dense numpy array, truncated to numTrials rows and squeezed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="k">def</span><span class="w"> </span><span class="nf">convert_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">    Convert sparse or dense array to dense numpy array.</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">    Truncates data to numTrials rows and converts sparse matrices to</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="sd">    dense arrays.</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a><span class="sd">    data : np.ndarray or scipy.sparse.spmatrix</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">        Input data, which may be sparse or dense.</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="sd">    -------</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a><span class="sd">        Dense numpy array, truncated to numTrials rows and squeezed.</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.convert_rotary_encoder_to_position" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_rotary_encoder_to_position</span><span class="p">(</span><span class="n">rotaryEncoder</span><span class="p">,</span> <span class="n">rigInfo</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.B2Registration.convert_rotary_encoder_to_position" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Convert rotary encoder counts to position in centimeters.</p>
<p>The rotary encoder is a counter with a large range that sometimes
wraps around. This method handles wrap-around, computes cumulative
movement, and scales to centimeters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>rotaryEncoder</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rotary encoder counts from timeline.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rigInfo</code>
            </td>
            <td>
                  <code><span title="vrAnalysis.registration.register.DefaultRigInfo">DefaultRigInfo</span> or <span title="similar">similar</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rig information containing rotary encoder parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position in centimeters, shape (num_samples,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-608" name="__codelineno-0-608"></a><span class="k">def</span><span class="w"> </span><span class="nf">convert_rotary_encoder_to_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rotaryEncoder</span><span class="p">,</span> <span class="n">rigInfo</span><span class="p">):</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">    Convert rotary encoder counts to position in centimeters.</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">    The rotary encoder is a counter with a large range that sometimes</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="sd">    wraps around. This method handles wrap-around, computes cumulative</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="sd">    movement, and scales to centimeters.</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><span class="sd">    rotaryEncoder : np.ndarray</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a><span class="sd">        Rotary encoder counts from timeline.</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a><span class="sd">    rigInfo : DefaultRigInfo or similar</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="sd">        Rig information containing rotary encoder parameters.</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">    -------</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="sd">        Position in centimeters, shape (num_samples,).</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>    <span class="c1"># rotary encoder is a counter with a big range that sometimes flips around it&#39;s axis</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="c1"># first get changes in encoder position, fix any big jumps in value, take the cumulative movement and scale to centimeters</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>    <span class="n">rotary_movement</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">diffsame</span><span class="p">(</span><span class="n">rotaryEncoder</span><span class="p">)</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>    <span class="n">idx_high_values</span> <span class="o">=</span> <span class="n">rotary_movement</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>    <span class="n">idx_low_values</span> <span class="o">=</span> <span class="n">rotary_movement</span> <span class="o">&lt;</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>    <span class="n">rotary_movement</span><span class="p">[</span><span class="n">idx_high_values</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">**</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>    <span class="n">rotary_movement</span><span class="p">[</span><span class="n">idx_low_values</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">rigInfo</span><span class="o">.</span><span class="n">rotaryRange</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>    <span class="k">return</span> <span class="n">rigInfo</span><span class="o">.</span><span class="n">rotEncSign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rotary_movement</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rigInfo</span><span class="o">.</span><span class="n">wheelRadius</span><span class="p">)</span> <span class="o">/</span> <span class="n">rigInfo</span><span class="o">.</span><span class="n">wheelToVR</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.create_index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_index</span><span class="p">(</span><span class="n">time_stamps</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.B2Registration.create_index" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Create index arrays for non-zero/non-NaN timestamps per trial.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>time_stamps</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamps as (numTrials x numSamples) dense numpy array.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>list of np.ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of index arrays, one per trial, indicating which samples
have valid data (non-NaN or non-zero).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_stamps</span><span class="p">):</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="sd">    Create index arrays for non-zero/non-NaN timestamps per trial.</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="sd">    time_stamps : np.ndarray</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="sd">        Timestamps as (numTrials x numSamples) dense numpy array.</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><span class="sd">    -------</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="sd">    list of np.ndarray</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a><span class="sd">        List of index arrays, one per trial, indicating which samples</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a><span class="sd">        have valid data (non-NaN or non-zero).</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>    <span class="c1"># requires timestamps as (numTrials x numSamples) dense numpy array</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">time_stamps</span><span class="p">)):</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">t</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_stamps</span><span class="p">]</span>  <span class="c1"># in case we have dense timestamps with nans where no data</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_stamps</span><span class="p">]</span>  <span class="c1"># in case we have sparse timestamps with 0s where no data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.do_preprocessing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">do_preprocessing</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.do_preprocessing" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Run all preprocessing steps for the session.</p>
<p>Processes timeline data, behavioral data, imaging data, red cell
identification, facecam data (placeholder), and creates mappings
between behavioral and imaging data.</p>


<details class="note" open>
  <summary>Notes</summary>
  <p>Processing steps are run in order:
1. Timeline processing
2. Behavior processing
3. Imaging processing
4. Red cell processing (if enabled)
5. Facecam processing (not yet implemented)
6. Behavior-to-imaging mapping</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="k">def</span><span class="w"> </span><span class="nf">do_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Run all preprocessing steps for the session.</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    Processes timeline data, behavioral data, imaging data, red cell</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">    identification, facecam data (placeholder), and creates mappings</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    between behavioral and imaging data.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">    -----</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">    Processing steps are run in order:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">    1. Timeline processing</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    2. Behavior processing</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">    3. Imaging processing</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    4. Red cell processing (if enabled)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">    5. Facecam processing (not yet implemented)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    6. Behavior-to-imaging mapping</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">clearOne</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_one_data</span><span class="p">(</span><span class="n">certainty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">process_timeline</span><span class="p">()</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">process_behavior</span><span class="p">()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">process_imaging</span><span class="p">()</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">process_red_cells</span><span class="p">()</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">process_facecam</span><span class="p">()</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">process_behavior_to_imaging</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.get_timeline_var" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_timeline_var</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.B2Registration.get_timeline_var" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get a timeline variable by name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>var_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the timeline variable to retrieve. Can be "timestamps"
or any hardware input name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeline variable data as a 1D array.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If var_name is not a valid timeline variable name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_timeline_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">    Get a timeline variable by name.</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">    var_name : str</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="sd">        Name of the timeline variable to retrieve. Can be &quot;timestamps&quot;</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">        or any hardware input name.</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">    -------</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">        Timeline variable data as a 1D array.</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">    ------</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">    AssertionError</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">        If var_name is not a valid timeline variable name.</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tl_file&quot;</span><span class="p">):</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_timeline_structure</span><span class="p">()</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>    <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;rawDAQTimestamps&quot;</span><span class="p">]</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>        <span class="n">inputNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeline_inputs</span><span class="p">(</span><span class="n">ignore_timestamps</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="k">assert</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">inputNames</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> is not a tl_file in session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;rawDAQData&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">inputName</span> <span class="o">==</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">inputName</span> <span class="ow">in</span> <span class="n">inputNames</span><span class="p">])[</span><span class="mi">0</span><span class="p">]])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.get_vr_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_vr_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nzindex</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.B2Registration.get_vr_data" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Extract valid data samples using index arrays.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data array, shape (numTrials, numSamples).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nzindex</code>
            </td>
            <td>
                  <code>list of np.ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of index arrays, one per trial, indicating valid samples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>list of np.ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of data arrays, one per trial, containing only valid samples.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_vr_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nzindex</span><span class="p">):</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="sd">    Extract valid data samples using index arrays.</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="sd">    data : np.ndarray</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">        Data array, shape (numTrials, numSamples).</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><span class="sd">    nzindex : list of np.ndarray</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="sd">        List of index arrays, one per trial, indicating valid samples.</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="sd">    -------</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="sd">    list of np.ndarray</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">        List of data arrays, one per trial, containing only valid samples.</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">nz</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">nz</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nzindex</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.load_behavior_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_behavior_structure</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.load_behavior_structure" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Load behavioral structure from VRBehavior_trial.mat file.</p>
<p>Loads the VRBehavior_trial.mat file produced by vrControl and stores
it in self.vr_file. If rigInfo is missing, uses DefaultRigInfo as
a fallback.</p>


<details class="note" open>
  <summary>Notes</summary>
  <p>The behavior file contains trial-level and sample-level behavioral
data including timestamps, positions, rewards, and licks. The file
is expected to be named
"{date}<em>{session_id}</em>{mouse_name}_VRBehavior_trial.mat".</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_behavior_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">    Load behavioral structure from VRBehavior_trial.mat file.</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">    Loads the VRBehavior_trial.mat file produced by vrControl and stores</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">    it in self.vr_file. If rigInfo is missing, uses DefaultRigInfo as</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">    a fallback.</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="sd">    -----</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="sd">    The behavior file contains trial-level and sample-level behavioral</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">    data including timestamps, positions, rewards, and licks. The file</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="sd">    is expected to be named</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">    &quot;{date}_{session_id}_{mouse_name}_VRBehavior_trial.mat&quot;.</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="n">vr_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse_name</span><span class="si">}</span><span class="s2">_VRBehavior_trial.mat&quot;</span>  <span class="c1"># vrBehavior output file name</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span> <span class="o">=</span> <span class="n">scio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">vr_file_name</span><span class="p">,</span> <span class="n">struct_as_record</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze_me</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="k">if</span> <span class="s2">&quot;rigInfo&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assuming default settings for B2 using `DefaultRigInfo()` in session: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">!!!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultRigInfo</span><span class="p">()</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">],</span> <span class="s2">&quot;rotaryRange&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rotaryRange</span> <span class="o">=</span> <span class="mi">32</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.load_timeline_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_timeline_structure</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.load_timeline_structure" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Load timeline structure from Timeline.mat file.</p>
<p>Loads the Timeline.mat file produced by rigbox and stores it in
self.tl_file. The file is expected to be named
"{date}<em>{session_id}</em>{mouse_name}_Timeline.mat".</p>


<details class="note" open>
  <summary>Notes</summary>
  <p>The timeline file contains raw DAQ data, timestamps, and hardware
input measurements from the experimental rig.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_timeline_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">    Load timeline structure from Timeline.mat file.</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">    Loads the Timeline.mat file produced by rigbox and stores it in</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">    self.tl_file. The file is expected to be named</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">    &quot;{date}_{session_id}_{mouse_name}_Timeline.mat&quot;.</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">    -----</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">    The timeline file contains raw DAQ data, timestamps, and hardware</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">    input measurements from the experimental rig.</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="n">tl_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse_name</span><span class="si">}</span><span class="s2">_Timeline.mat&quot;</span>  <span class="c1"># timeline.mat file name</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span> <span class="o">=</span> <span class="n">scio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">tl_file_name</span><span class="p">,</span> <span class="n">simplify_cells</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;Timeline&quot;</span><span class="p">]</span>  <span class="c1"># load matlab structure</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.process_behavior" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_behavior</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.process_behavior" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Process behavioral data from vrControl.</p>
<p>Processes behavioral data using the appropriate behavior processing
function based on the vrBehaviorVersion option. Extracts trial-level
and sample-level behavioral data and aligns timestamps to the timeline.</p>


<details class="see-also" open>
  <summary>See Also</summary>
  <p>register_behavior : Dispatcher function for behavior processing.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    Process behavioral data from vrControl.</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">    Processes behavioral data using the appropriate behavior processing</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">    function based on the vrBehaviorVersion option. Extracts trial-level</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">    and sample-level behavioral data and aligns timestamps to the timeline.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">    See Also</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">    --------</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">    register_behavior : Dispatcher function for behavior processing.</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="bp">self</span> <span class="o">=</span> <span class="n">register_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">vrBehaviorVersion</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="c1"># Confirm that vrBehavior has been processed</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;vrBehavior&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.process_behavior_to_imaging" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_behavior_to_imaging</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.process_behavior_to_imaging" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Create mapping from behavioral frames to imaging frames.</p>
<p>Computes the nearest imaging frame for each behavioral sample and
saves the mapping to oneData.</p>


<details class="note" open>
  <summary>Notes</summary>
  <p>This method is skipped if imaging is disabled in opts. The mapping
is saved as "positionTracking.mpci" in oneData.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_behavior_to_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">    Create mapping from behavioral frames to imaging frames.</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">    Computes the nearest imaging frame for each behavioral sample and</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">    saves the mapping to oneData.</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><span class="sd">    -----</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><span class="sd">    This method is skipped if imaging is disabled in opts. The mapping</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="sd">    is saved as &quot;positionTracking.mpci&quot; in oneData.</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">imaging</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, imaging setting set to False in opts[&#39;imaging&#39;]. Skipping behavior2imaging processing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>    <span class="c1"># compute translation mapping from behave frames to imaging frames</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>    <span class="n">idx_behave_to_frame</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">nearestpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;positionTracking.times&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpci.times&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">idx_behave_to_frame</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;positionTracking.mpci&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.process_facecam" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_facecam</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.process_facecam" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Process facecam data.</p>
<p>Placeholder for facecam preprocessing. Not yet implemented.</p>


<details class="note" open>
  <summary>Notes</summary>
  <p>This method currently only prints a message indicating that facecam
preprocessing has not been implemented yet.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_facecam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="sd">    Process facecam data.</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">    Placeholder for facecam preprocessing. Not yet implemented.</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">    -----</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">    This method currently only prints a message indicating that facecam</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">    preprocessing has not been implemented yet.</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Facecam preprocessing has not been coded yet!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.process_imaging" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_imaging</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.process_imaging" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Process imaging data from suite2p outputs.</p>
<p>Loads suite2p outputs, identifies available planes and outputs,
handles frame count mismatches between suite2p and timeline,
optionally recomputes deconvolution using OASIS, and saves imaging
data to oneData format.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If imaging is requested but suite2p directory does not exist, or
if required suite2p outputs are missing, or if frame count
mismatches cannot be resolved.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This method:
- Identifies planes and available suite2p outputs
- Checks for required outputs (stat, ops, F, Fneu, iscell, spks)
- Handles frame count mismatches between suite2p and timeline
- Optionally recomputes deconvolution using OASIS
- Saves imaging data to oneData</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">    Process imaging data from suite2p outputs.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">    Loads suite2p outputs, identifies available planes and outputs,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">    handles frame count mismatches between suite2p and timeline,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">    optionally recomputes deconvolution using OASIS, and saves imaging</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">    data to oneData format.</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    ------</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">    ValueError</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">        If imaging is requested but suite2p directory does not exist, or</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">        if required suite2p outputs are missing, or if frame count</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        mismatches cannot be resolved.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">    -----</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">    This method:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">    - Identifies planes and available suite2p outputs</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">    - Checks for required outputs (stat, ops, F, Fneu, iscell, spks)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">    - Handles frame count mismatches between suite2p and timeline</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">    - Optionally recomputes deconvolution using OASIS</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">    - Saves imaging data to oneData</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">imaging</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, imaging setting set to False in opts[&#39;imaging&#39;]. Skipping image processing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2p_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, suite2p processing was requested but suite2p directory does not exist.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="c1"># identifies which planes were processed through suite2p (assume that those are all available planes)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="c1"># identifies which s2p outputs are available from each plane</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">plane</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2p_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;plane*/&quot;</span><span class="p">)])</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;planeIDs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">planeName</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span> <span class="k">for</span> <span class="n">planeName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">)])</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="n">npysInPlanes</span> <span class="o">=</span> <span class="p">[[</span><span class="n">npy</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">npy</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">s2p_path</span> <span class="o">/</span> <span class="n">planeName</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.npy&quot;</span><span class="p">))]</span> <span class="k">for</span> <span class="n">planeName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="n">commonNPYs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">npy</span><span class="p">)</span> <span class="k">for</span> <span class="n">npy</span> <span class="ow">in</span> <span class="n">npysInPlanes</span><span class="p">]))</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="n">unionNPYs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">npy</span><span class="p">)</span> <span class="k">for</span> <span class="n">npy</span> <span class="ow">in</span> <span class="n">npysInPlanes</span><span class="p">]))</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">commonNPYs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">unionNPYs</span><span class="p">):</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="sa">f</span><span class="s2">&quot;The following npy files are present in some but not all plane folders within session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unionNPYs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">commonNPYs</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each plane folder contains the following npy files: </span><span class="si">{</span><span class="n">commonNPYs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">,</span> <span class="n">commonNPYs</span><span class="p">)</span>  <span class="c1"># a list of npy files available in each plane folder</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="c1"># required variables (anything else is either optional or can be computed independently)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="s2">&quot;ops&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;Fneu&quot;</span><span class="p">,</span> <span class="s2">&quot;iscell&quot;</span><span class="p">]</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">oasis</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="c1"># add deconvolved spikes to required variable if we aren&#39;t recomputing it here</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;spks&quot;</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="k">for</span> <span class="n">varName</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="k">assert</span> <span class="n">varName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2"> is missing </span><span class="si">{</span><span class="n">varName</span><span class="si">}</span><span class="s2"> in at least one suite2p folder!&quot;</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="c1"># get number of ROIs in each plane</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">iscell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">iscell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;iscell&quot;</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="c1"># get number of frames in each plane (might be different!)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">F</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>    <span class="n">assert_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The frame count in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2"> varies by more than 1 frame! (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;framePerPlane&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">assert_msg</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numROIs&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)))</span>  <span class="c1"># number of ROIs in session</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="c1"># number of frames to use when retrieving imaging data (might be overwritten to something smaller if timeline handled improperly)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;framePerPlane&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="c1"># Get timeline sample corresponding to each imaging volume</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="n">timeline_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;wheelPosition.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="n">changeFrames</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;neuralFrames&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeIDs&quot;</span><span class="p">)))),</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">changeFrames</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># TTLs for each volume (increments by 1 for each plane)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">timeline_timestamps</span><span class="p">[</span><span class="n">frame_samples</span><span class="p">]</span>  <span class="c1"># get timelineTimestamps of each imaging volume</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="c1"># Handle mismatch between number of imaging frames saved by scanImage (and propagated through suite2p), and between timeline&#39;s measurement of the scanImage frame counter</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">):</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">):</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="c1"># If frame_to_time had one more frame, just trim it and assume everything is fine. This happens when a new volume was started but not finished, so does not required communication to user.</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">frame_samples</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">frame_to_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">):</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                <span class="s2">&quot;frame_to_time had 2 more than suite2p output. This happens sometimes. I don&#39;t like it. I think it&#39;s because scanimage sends a TTL before starting the frame&quot;</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">frame_samples</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">frame_to_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="c1"># If frameSamples has too few frames, it&#39;s possible that the scanImage signal to timeline was broken but scanImage still continued normally.</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="n">numMissing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numFrames&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_samples</span><span class="p">)</span>  <span class="c1"># measure number of missing frames</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="k">if</span> <span class="n">numMissing</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                <span class="c1"># If frameSamples had many more frames, generate an error -- something went wrong that needs manual inspection</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                    <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, frameSamples has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_samples</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements, but </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;numFrames&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames were reported in suite2p. Cannot resolve.&quot;</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>                <span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot fix mismatches when suite2p data is missing!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="c1"># It&#39;s possible that the scanImage signal to timeline was broken but scanImage still continued normally.</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="k">if</span> <span class="n">numMissing</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                    <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, more than one frameSamples sample was missing. Consider using tiff timelineTimestamps to reproduce accurately.&quot;</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                <span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="p">(</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                    <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, frameSamples has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_samples</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements, but </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;numFrames&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames were saved by suite2p. &quot;</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                    <span class="s2">&quot;Will extend frameSamples using the typical sampling rate and nearestpoint algorithm.&quot;</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                <span class="p">)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="c1"># If frame_to_time difference vector is consistent within 1%, then use mean (which is a little more accurate), otherwise use median</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">timeline_timestamps</span><span class="p">[</span><span class="n">frame_samples</span><span class="p">]</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="n">medianFramePeriod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))</span>  <span class="c1"># measure median sample period</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="n">consistentFrames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">medianFramePeriod</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.01</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="p">)</span>  <span class="c1"># True if all frames take within 1% of median frame period</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="k">if</span> <span class="n">consistentFrames</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="n">samplePeriod_f2t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="n">samplePeriod_f2t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="n">appendFrames</span> <span class="o">=</span> <span class="n">frame_to_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">samplePeriod_f2t</span> <span class="o">*</span> <span class="p">(</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numMissing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="p">)</span>  <span class="c1"># add elements to frame_to_time, assume sampling rate was perfect</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="n">frame_to_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">frame_to_time</span><span class="p">,</span> <span class="n">appendFrames</span><span class="p">))</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="n">frame_samples</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">nearestpoint</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">,</span> <span class="n">timeline_timestamps</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="c1"># average percentage difference between all samples differences and median -- just a useful metric to be saved --</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="s2">&quot;samplingDeviationMedianPercentError&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))))))</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="s2">&quot;samplingDeviationMaximumPercentError&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">))))))</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="c1"># recompute deconvolution if requested</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="n">spks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;spks&quot;</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">oasis</span><span class="p">:</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="c1"># set parameters for oasis and get corrected fluorescence traces</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">tau</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="n">fcorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadfcorr</span><span class="p">(</span><span class="n">try_from_one</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">oasis_deconvolution</span><span class="p">(</span><span class="n">fcorr</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="n">ospks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="c1"># Check that the shape is correct</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, oasis was run and did not produce the same shaped array as suite2p spks...&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="k">assert</span> <span class="n">ospks</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">spks</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">msg</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="c1"># save onedata (no assertions needed, loadS2P() handles shape checks and this function already handled any mismatch between frameSamples and suite2p output</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">frame_to_time</span><span class="p">,</span> <span class="s2">&quot;mpci.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transpose&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpci.roiActivityF&quot;</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;Fneu&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transpose&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpci.roiNeuropilActivityF&quot;</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;spks&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transpose&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpci.roiActivityDeconvolved&quot;</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="k">if</span> <span class="s2">&quot;redcell&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">):</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;redcell&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;idx_column1&quot;</span><span class="p">]),</span> <span class="s2">&quot;mpciROIs.redS2P&quot;</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">LoadingRecipe</span><span class="p">(</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;iscell&quot;</span><span class="p">),</span> <span class="s2">&quot;mpciROIs.isCell&quot;</span><span class="p">)</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_roi_position</span><span class="p">(),</span> <span class="s2">&quot;mpciROIs.stackPosition&quot;</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">oasis</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">ospks</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s2">&quot;mpci.roiActivityDeconvolvedOasis&quot;</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;imaging&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.process_red_cells" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_red_cells</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.process_red_cells" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Process red cell features for identification.</p>
<p>Computes red cell features (dot product, Pearson correlation, phase
correlation) using RedCellProcessing and saves them to oneData.
Initializes red cell index and manual assignment arrays.</p>


<details class="note" open>
  <summary>Notes</summary>
  <p>This method is skipped if imaging or redCellProcessing is disabled in opts,
or if redcell output is not available in suite2p. The computed features
are saved to oneData for later use in red cell identification.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_red_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">    Process red cell features for identification.</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">    Computes red cell features (dot product, Pearson correlation, phase</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">    correlation) using RedCellProcessing and saves them to oneData.</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">    Initializes red cell index and manual assignment arrays.</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><span class="sd">    -----</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="sd">    This method is skipped if imaging or redCellProcessing is disabled in opts,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">    or if redcell output is not available in suite2p. The computed features</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">    are saved to oneData for later use in red cell identification.</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">imaging</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">redCellProcessing</span><span class="p">):</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="k">return</span>  <span class="c1"># if not requested, skip function</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>    <span class="c1"># if imaging was processed and redCellProcessing was requested, then try to preprocess red cell features</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>    <span class="k">if</span> <span class="s2">&quot;redcell&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">):</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, &#39;redcell&#39; is not an available suite2p output, although &#39;redCellProcessing&#39; was requested.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="k">return</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="c1"># create RedCellProcessing object</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>    <span class="c1"># b2session_of_self = B2Session.create(self.mouse_name, self.date, self.session_id, for_registration=True)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>    <span class="n">red_cell_processing</span> <span class="o">=</span> <span class="n">RedCellProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>    <span class="c1"># compute red-features</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="n">dot_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lowcut&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;highcut&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;fs&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">}</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>    <span class="n">corr_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;lowcut&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;highcut&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;fs&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">}</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>    <span class="n">phase_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span> <span class="s2">&quot;winFunc&quot;</span><span class="p">:</span> <span class="s2">&quot;hamming&quot;</span><span class="p">}</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing red cell features for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">... (usually takes 10-20 seconds)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>    <span class="n">dot_product</span> <span class="o">=</span> <span class="n">red_cell_processing</span><span class="o">.</span><span class="n">compute_dot</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">dot_parameters</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">red_cell_processing</span><span class="o">.</span><span class="n">compute_corr</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">corr_parameters</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>    <span class="n">phase_corr</span> <span class="o">=</span> <span class="n">red_cell_processing</span><span class="o">.</span><span class="n">cropped_phase_correlation</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">phase_parameters</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>    <span class="c1"># initialize annotations</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numROIs&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">),</span> <span class="s2">&quot;mpciROIs.redCellIdx&quot;</span><span class="p">)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numROIs&quot;</span><span class="p">)),</span> <span class="kc">False</span><span class="p">),</span> <span class="s2">&quot;mpciROIs.redCellManualAssignments&quot;</span><span class="p">)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="c1"># save oneData</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">dot_product</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redDotProduct&quot;</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">corr_coeff</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redPearson&quot;</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">phase_corr</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redPhaseCorrelation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dot_parameters</span><span class="p">),</span> <span class="s2">&quot;parametersRedDotProduct.keyValuePairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corr_parameters</span><span class="p">),</span> <span class="s2">&quot;parametersRedPearson.keyValuePairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_parameters</span><span class="p">),</span> <span class="s2">&quot;parametersRedPhaseCorrelation.keyValuePairs&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.process_timeline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_timeline</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.process_timeline" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Process timeline data from rigbox.</p>
<p>Extracts timestamps, rotary encoder position, lick times, reward times,
and trial start times from the Timeline.mat file. Processes photodiode
signals to align trial starts with imaging frames.</p>


<details class="note" open>
  <summary>Notes</summary>
  <p>This method:
- Loads timeline structure from Timeline.mat
- Converts rotary encoder to position
- Detects licks and rewards
- Processes photodiode signal to find trial start frames
- Saves timeline data to oneData</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_timeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">    Process timeline data from rigbox.</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">    Extracts timestamps, rotary encoder position, lick times, reward times,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    and trial start times from the Timeline.mat file. Processes photodiode</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">    signals to align trial starts with imaging frames.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">    -----</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">    This method:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">    - Loads timeline structure from Timeline.mat</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    - Converts rotary encoder to position</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">    - Detects licks and rewards</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">    - Processes photodiode signal to find trial start frames</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">    - Saves timeline data to oneData</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="c1"># load these files for raw behavioral &amp; timeline data</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">load_timeline_structure</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">load_behavior_structure</span><span class="p">()</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="c1"># get time stamps, photodiode, trial start and end times, room position, lick times, trial idx, visual data visible</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">mpepStartTimes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="k">for</span> <span class="n">mt</span><span class="p">,</span> <span class="n">me</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;mpepUDPTimes&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;mpepUDPEvents&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="k">if</span> <span class="s2">&quot;TrialStart&quot;</span> <span class="ow">in</span> <span class="n">me</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">mpepStartTimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="k">elif</span> <span class="s2">&quot;StimStart&quot;</span> <span class="ow">in</span> <span class="n">me</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="n">mpepStartTimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="n">mpepStartTimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mpepStartTimes</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="n">timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;timestamps&quot;</span><span class="p">)</span>  <span class="c1"># load timestamps</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="c1"># Get rotary position -- (load timeline measurement of rotary encoder, which is a circular position counter, use vrExperiment function to convert to a running measurement of position)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="n">rotaryEncoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;rotaryEncoder&quot;</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="n">rotaryPosition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_rotary_encoder_to_position</span><span class="p">(</span><span class="n">rotaryEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;rigInfo&quot;</span><span class="p">])</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="c1"># Get Licks (uses an edge counter)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="n">lickDetector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;lickDetector&quot;</span><span class="p">)</span>  <span class="c1"># load lick detector copy</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="n">lickSamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">diffsame</span><span class="p">(</span><span class="n">lickDetector</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>  <span class="c1"># timeline samples of lick times</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="c1"># Get Reward Commands (measures voltage of output -- assume it&#39;s either low or high)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="n">rewardCommand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;rewardCommand&quot;</span><span class="p">)</span>  <span class="c1"># load reward command signal</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">rewardCommand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rewardCommand</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rewardCommand</span><span class="p">))</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">rewardSamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">diffsame</span><span class="p">(</span><span class="n">rewardCommand</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>  <span class="c1"># timeline samples when reward was delivered</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="c1"># Now process photodiode signal</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="n">photodiode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_var</span><span class="p">(</span><span class="s2">&quot;photoDiode&quot;</span><span class="p">)</span>  <span class="c1"># load lick detector copy</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="c1"># Remove any slow trends</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">pdDetrend</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">photodiode</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">pdDetrend</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdDetrend</span> <span class="o">-</span> <span class="n">pdDetrend</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">pdDetrend</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="c1"># median filter and take smooth derivative</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="n">hfpd</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">refreshRate</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># hz</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="n">refreshSamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">refreshRate</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)))</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="n">pdMedFilt</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">pdDetrend</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">refreshSamples</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">pdDerivative</span><span class="p">,</span> <span class="n">pdIndex</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">fivePointDer</span><span class="p">(</span><span class="n">pdMedFilt</span><span class="p">,</span> <span class="n">hfpd</span><span class="p">,</span> <span class="n">returnIndex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="n">pdDerivative</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">pdDerivative</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="n">pdDerTime</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">pdIndex</span><span class="p">]</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="c1"># find upward and downward peaks, not perfect but in practice close enough</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="n">locUp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">pdDerivative</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">refreshSamples</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="n">locDn</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">pdDerivative</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">refreshSamples</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="n">flipTimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pdDerTime</span><span class="p">[</span><span class="n">locUp</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">pdDerTime</span><span class="p">[</span><span class="n">locDn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="n">flipValue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locUp</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locDn</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>    <span class="n">flipSortIdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">flipTimes</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="n">flipTimes</span> <span class="o">=</span> <span class="n">flipTimes</span><span class="p">[</span><span class="n">flipSortIdx</span><span class="p">]</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="n">flipValue</span> <span class="o">=</span> <span class="n">flipValue</span><span class="p">[</span><span class="n">flipSortIdx</span><span class="p">]</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="c1"># Naive Method (just look for flips before and after trialstart/trialend mpep message:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="c1"># A sophisticated message uses the time of the photodiode ramps, but those are really just for safety and rare manual curation...</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="n">firstFlipIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flipTimes</span> <span class="o">&gt;=</span> <span class="n">mpepStart</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">mpepStart</span> <span class="ow">in</span> <span class="n">mpepStartTimes</span><span class="p">])</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="n">startTrialIndex</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">nearestpoint</span><span class="p">(</span><span class="n">flipTimes</span><span class="p">[</span><span class="n">firstFlipIndex</span><span class="p">],</span> <span class="n">timestamps</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># returns frame index of first photodiode flip in each trial</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="c1"># Check that first flip is always down -- all of the vrControl code prepares trials in this way</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2022-08-30&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">):</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="c1"># But it didn&#39;t prepare it this way before august 30th :(</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flipValue</span><span class="p">[</span><span class="n">firstFlipIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;In session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sessionPrint</span><span class="p">()</span><span class="si">}</span><span class="s2">, first flips in trial are not all down!!&quot;</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="c1"># Check shapes of timeline arrays</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>    <span class="k">assert</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;timelineTimestamps is not a 1-d array!&quot;</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="k">assert</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">rotaryPosition</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;timeline timestamps and rotary position arrays do not have the same shape!&quot;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="c1"># Save timeline oneData</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="s2">&quot;wheelPosition.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">rotaryPosition</span><span class="p">,</span> <span class="s2">&quot;wheelPosition.position&quot;</span><span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">lickSamples</span><span class="p">],</span> <span class="s2">&quot;licks.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">rewardSamples</span><span class="p">],</span> <span class="s2">&quot;rewards.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">startTrialIndex</span><span class="p">],</span> <span class="s2">&quot;trials.startTimes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;timeline&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.register" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.B2Registration.register" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Register the session by running all preprocessing steps.</p>
<p>This is the main entry point for registration. It runs all preprocessing
steps (timeline, behavior, imaging, red cells, facecam, behavior-to-imaging)
and saves session parameters.</p>


<details class="see-also" open>
  <summary>See Also</summary>
  <p>do_preprocessing : Run all preprocessing steps.
save_session_prms : Save session parameters to oneData.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">    Register the session by running all preprocessing steps.</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    This is the main entry point for registration. It runs all preprocessing</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">    steps (timeline, behavior, imaging, red cells, facecam, behavior-to-imaging)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    and saves session parameters.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">    See Also</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">    --------</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    do_preprocessing : Run all preprocessing steps.</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">    save_session_prms : Save session parameters to oneData.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">do_preprocessing</span><span class="p">()</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">save_session_prms</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.B2Registration.timeline_inputs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">timeline_inputs</span><span class="p">(</span><span class="n">ignore_timestamps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.B2Registration.timeline_inputs" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get list of available timeline input names.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ignore_timestamps</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, return only hardware input names. If False, include
"timestamps" as the first element. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of timeline input names.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/register.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="k">def</span><span class="w"> </span><span class="nf">timeline_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_timestamps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">    Get list of available timeline input names.</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">    ignore_timestamps : bool, optional</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">        If True, return only hardware input names. If False, include</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">        &quot;timestamps&quot; as the first element. Default is False.</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">    -------</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">    list of str</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">        List of timeline input names.</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tl_file&quot;</span><span class="p">):</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_timeline_structure</span><span class="p">()</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="n">hw_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">hwInput</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hwInput</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tl_file</span><span class="p">[</span><span class="s2">&quot;hw&quot;</span><span class="p">][</span><span class="s2">&quot;inputs&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="k">if</span> <span class="n">ignore_timestamps</span><span class="p">:</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="k">return</span> <span class="n">hw_inputs</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">hw_inputs</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="vrAnalysis.registration.RedCellProcessing" class="doc doc-heading">
            <code>RedCellProcessing</code>


<a href="#vrAnalysis.registration.RedCellProcessing" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">



        <p>Handle red cell processing for B2Registration sessions.</p>
<p>This class processes red cell data from suite2p outputs, computes features
for identifying red cells (S2P, dot product, Pearson correlation, phase
correlation), and provides methods for updating red cell indices based on
cutoff criteria.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>b2session</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Session


  
      dataclass
   (vrAnalysis.sessions.B2Session)" href="../b2session/#vrAnalysis.sessions.B2Session">B2Session</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Session object containing the session data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>um_per_pixel</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Micrometers per pixel for spatial measurements. Default is 1.3.</p>
              </div>
            </td>
            <td>
                  <code>1.3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>autoload</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, automatically load reference images and masks on initialization.
Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.b2session">b2session</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Session


  
      dataclass
   (vrAnalysis.sessions.B2Session)" href="../b2session/#vrAnalysis.sessions.B2Session">B2Session</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Session object containing the session data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.feature_names">feature_names</span></code></td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Standard names of features used to determine red cell criterion.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.num_planes">num_planes</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of imaging planes in the session.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.um_per_pixel">um_per_pixel</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Micrometers per pixel for spatial measurements.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.data_loaded">data_loaded</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether reference images and masks have been loaded.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.reference">reference</span></code></td>
            <td>
                  <code>list of np.ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference images for each plane (loaded when data_loaded is True).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.lx, ly">lx, ly</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dimensions of reference images.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.lam">lam</span></code></td>
            <td>
                  <code>list of np.ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weights of each pixel in ROI masks.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.ypix, xpix">ypix, xpix</span></code></td>
            <td>
                  <code>list of np.ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel indices for each ROI mask.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.roi_plane_idx">roi_plane_idx</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Plane index for each ROI.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="vrAnalysis.registration.RedCellProcessing.red_s2p">red_s2p</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suite2p red cell values for each ROI.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">RedCellProcessing</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Handle red cell processing for B2Registration sessions.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    This class processes red cell data from suite2p outputs, computes features</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    for identifying red cells (S2P, dot product, Pearson correlation, phase</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    correlation), and provides methods for updating red cell indices based on</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    cutoff criteria.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    b2session : B2Session</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        The B2Session object containing the session data.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    um_per_pixel : float, optional</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        Micrometers per pixel for spatial measurements. Default is 1.3.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    autoload : bool, optional</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        If True, automatically load reference images and masks on initialization.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        Default is True.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Attributes</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    b2session : B2Session</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        The B2Session object containing the session data.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    feature_names : list of str</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Standard names of features used to determine red cell criterion.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    num_planes : int</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        Number of imaging planes in the session.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    um_per_pixel : float</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        Micrometers per pixel for spatial measurements.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    data_loaded : bool</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        Whether reference images and masks have been loaded.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    reference : list of np.ndarray</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        Reference images for each plane (loaded when data_loaded is True).</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    lx, ly : int</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        Dimensions of reference images.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    lam : list of np.ndarray</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        Weights of each pixel in ROI masks.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    ypix, xpix : list of np.ndarray</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        Pixel indices for each ROI mask.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    roi_plane_idx : np.ndarray</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        Plane index for each ROI.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    red_s2p : np.ndarray</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        Suite2p red cell values for each ROI.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">b2session</span><span class="p">:</span> <span class="s2">&quot;B2Session&quot;</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">um_per_pixel</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.3</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">autoload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="p">):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        Initialize RedCellProcessing object.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        b2session : B2Session</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            The B2Session object containing the session data.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        um_per_pixel : float, optional</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            Micrometers per pixel for spatial measurements. Default is 1.3.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        autoload : bool, optional</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            If True, automatically load reference images and masks on initialization.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            Default is True.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        ------</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        AssertionError</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            If redcell is not available in suite2p outputs.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="c1"># Make sure redcell is available...</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;redcell is not an available suite2p output, so you can&#39;t do redCellProcessing.&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">assert</span> <span class="s2">&quot;redcell&quot;</span> <span class="ow">in</span> <span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">),</span> <span class="n">msg</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span> <span class="o">=</span> <span class="n">b2session</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="c1"># standard names of the features used to determine red cell criterion</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;dotProduct&quot;</span><span class="p">,</span> <span class="s2">&quot;pearson&quot;</span><span class="p">,</span> <span class="s2">&quot;phaseCorrelation&quot;</span><span class="p">]</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="c1"># load some critical values for easy readable access</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">))</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span> <span class="o">=</span> <span class="n">um_per_pixel</span>  <span class="c1"># store this for generating correct axes and measuring distances</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># initialize to false in case data isn&#39;t loaded</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>  <span class="c1"># prepare reference images and ROI mask data</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="c1"># ------------------------------</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="c1"># -- initialization functions --</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="c1"># ------------------------------</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_reference_and_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        Load reference images and ROI masks from suite2p outputs.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        Loads the mean image for channel 2 (red channel) for each plane, along</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        with ROI mask data (lam, ypix, xpix) and ROI plane indices. Also loads</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        suite2p red cell values and creates supporting variables for spatial</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        measurements.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        ------</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        AssertionError</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">            If reference images do not all have the same shape.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="c1"># load reference images</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;ops&quot;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="p">[</span><span class="s2">&quot;meanImg_chan2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;reference images do not all have the same shape&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">)</span> <span class="o">==</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">msg</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="c1"># load masks (lam=weight of each pixel, xpix &amp; ypix=index of each pixel in ROI mask)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;stat&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;lam&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;ypix&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;xpix&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.stackPosition&quot;</span><span class="p">)[:,</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="c1"># load S2P red cell value</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">red_s2p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redS2P&quot;</span><span class="p">)</span>  <span class="c1"># (preloaded, will never change in this function)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="c1"># create supporting variables for mapping locations and axes</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_base_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_base_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_dist_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_centered_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_dist_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_centered_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="c1"># update data_loaded field</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="c1"># ---------------------------------</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="c1"># -- updating one data functions --</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="c1"># ---------------------------------</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">one_name_feature_cutoffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        Generate oneData name for feature cutoff parameters.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        name : str</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">            Feature name (e.g., &quot;S2P&quot;, &quot;dotProduct&quot;, &quot;pearson&quot;, &quot;phaseCorrelation&quot;).</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        -------</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        str</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">            OneData name for the feature cutoff parameter, formatted as</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">            &quot;parametersRed{Name}.minMaxCutoff&quot; where {Name} is the capitalized</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            feature name.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">return</span> <span class="s2">&quot;parameters&quot;</span> <span class="o">+</span> <span class="s2">&quot;Red&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.minMaxCutoff&quot;</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_red_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s2p_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dot_product_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corr_coef_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_corr_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        Update red cell index based on feature cutoff values.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        Updates the red cell index by applying minimum and maximum cutoffs to</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        each feature (S2P, dot product, Pearson correlation, phase correlation).</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        Only features with non-NaN cutoff values are applied. The red cell index</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        is updated to include only ROIs that meet all specified criteria.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        s2p_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">            [min, max] cutoff values for suite2p red cell feature. NaN values</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">            indicate the cutoff should not be applied. Default is None.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        dot_product_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">            [min, max] cutoff values for dot product feature. Default is None.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        corr_coef_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">            [min, max] cutoff values for Pearson correlation feature.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">            Default is None.</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        phase_corr_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">            [min, max] cutoff values for phase correlation feature.</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">            Default is None.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        ------</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        ValueError</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">            If any cutoff is not a numpy array or list, or if any cutoff does</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">            not have exactly 2 elements.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        -----</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">        Cutoff values are saved to oneData for future reference. The red cell</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">        index is updated in place and saved to oneData.</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="c1"># create initial all true red cell idx</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">red_cell_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redCellIdx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="c1"># load feature values for each ROI</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">red_s2p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redS2P&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">dot_product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redDotProduct&quot;</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">corr_coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redPearson&quot;</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="n">phase_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redPhaseCorrelation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="c1"># create lists for zipping through each feature/cutoff combination</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">red_s2p</span><span class="p">,</span> <span class="n">dot_product</span><span class="p">,</span> <span class="n">corr_coef</span><span class="p">,</span> <span class="n">phase_corr</span><span class="p">]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="n">cutoffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s2p_cutoff</span><span class="p">,</span> <span class="n">dot_product_cutoff</span><span class="p">,</span> <span class="n">corr_coef_cutoff</span><span class="p">,</span> <span class="n">phase_corr_cutoff</span><span class="p">]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="n">usecutoff</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cutoffs</span><span class="p">))]</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="c1"># check validity of each cutoff and identify whether it should be used</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">usecutoff</span><span class="p">,</span> <span class="n">cutoffs</span><span class="p">):</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting a numpy array or a list for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> cutoff, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> cutoff does not have 2 elements&quot;</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="n">use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="n">use</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="c1"># add feature cutoffs to redCellIdx (sets any to False that don&#39;t meet the cutoff)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">usecutoff</span><span class="p">,</span> <span class="n">cutoffs</span><span class="p">):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="k">if</span> <span class="n">use</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="n">red_cell_idx</span> <span class="o">&amp;=</span> <span class="n">feature</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="k">if</span> <span class="n">use</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="n">red_cell_idx</span> <span class="o">&amp;=</span> <span class="n">feature</span> <span class="o">&lt;=</span> <span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="c1"># save new red cell index to one data</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">red_cell_idx</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redCellIdx&quot;</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="c1"># save feature cutoffs to one data</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">):</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">cutoffs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_name_feature_cutoffs</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Red Cell curation choices are saved for session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red_cell</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">        Update red cell cutoffs from another session.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">        Copies red cell cutoff parameters from another RedCellProcessing object</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">        and applies them to this session.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">        red_cell : RedCellProcessing</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">            Another RedCellProcessing object to copy cutoffs from.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">        force_update : bool, optional</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">            If False, only allows copying from sessions with the same mouse name.</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">            If True, allows copying from any session. Default is False.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        ------</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        AssertionError</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">            If red_cell is not a RedCellProcessing object, or if force_update is</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">            False and the mouse names don&#39;t match.</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">red_cell</span><span class="p">,</span> <span class="n">RedCellProcessing</span><span class="p">),</span> <span class="s2">&quot;red_cell is not a RedCellProcessing object&quot;</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">force_update</span><span class="p">):</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="k">assert</span> <span class="p">(</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                <span class="n">red_cell</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">mouse_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">mouse_name</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="p">),</span> <span class="s2">&quot;session to copy from is from a different mouse, this isn&#39;t allowed without the force_update=True input&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">cutoffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">red_cell</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="n">red_cell</span><span class="o">.</span><span class="n">one_name_feature_cutoffs</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_red_idx</span><span class="p">(</span><span class="n">s2p_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dot_product_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">corr_coef_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">phase_corr_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cropped_phase_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">winFunc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">        Compute phase correlation of cropped masks with cropped reference images.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        Returns the phase correlation of each ROI mask (cropped around the ROI</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">        centroid) with the corresponding cropped reference image. This is used</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">        as a feature for identifying red cells.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">            Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        width : float, optional</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">            Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">            Default is 40.</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        eps : float, optional</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">            Small value added to avoid division by zero in phase correlation.</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">            Default is 1e6.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        winFunc : callable or str, optional</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">            Window function to apply before computing phase correlation. If &quot;hamming&quot;,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">            uses Hamming window. Otherwise should be a callable that takes an array</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">            and returns a windowed array. Default is Hamming window.</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        -------</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">        refStack : np.ndarray</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">            Stack of cropped reference images, shape (num_rois, height, width).</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        maskStack : np.ndarray</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">            Stack of cropped ROI masks, shape (num_rois, height, width).</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">        pxcStack : np.ndarray</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">            Stack of phase correlation maps, shape (num_rois, height, width).</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        phase_corr_values : np.ndarray</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">            Phase correlation values at the center of each correlation map,</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">            shape (num_rois,). This is the feature value used for red cell identification.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">        -----</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">        The default parameters (width=40um, eps=1e6, and a Hamming window function)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        were tested on a few sessions and are subjective. Manual curation and</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        parameter adjustment may be necessary for optimal results.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">if</span> <span class="n">winFunc</span> <span class="o">==</span> <span class="s2">&quot;hamming&quot;</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">winFunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">refStack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centered_reference_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>  <span class="c1"># get stack of reference image centered on each ROI</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="n">maskStack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centered_mask_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>  <span class="c1"># get stack of mask value centered on each ROI</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">window</span> <span class="o">=</span> <span class="n">winFunc</span><span class="p">(</span><span class="n">refStack</span><span class="p">)</span>  <span class="c1"># create a window function</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">pxcStack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="p">[</span><span class="n">helpers</span><span class="o">.</span><span class="n">phaseCorrelation</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">refStack</span><span class="p">,</span> <span class="n">maskStack</span><span class="p">)]</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="p">)</span>  <span class="c1"># measure phase correlation</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="n">pxcCenterPixel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pxcStack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="k">return</span> <span class="n">refStack</span><span class="p">,</span> <span class="n">maskStack</span><span class="p">,</span> <span class="n">pxcStack</span><span class="p">,</span> <span class="n">pxcStack</span><span class="p">[:,</span> <span class="n">pxcCenterPixel</span><span class="p">,</span> <span class="n">pxcCenterPixel</span><span class="p">]</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">        Compute normalized dot product between filtered reference and ROI masks.</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">        Computes the dot product between each ROI mask and a Butterworth-filtered</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        reference image. This is used as a feature for identifying red cells.</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">        plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">            Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">        lowcut : float, optional</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">            Low cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">            Default is 12.</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">        highcut : float, optional</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">            High cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">            Default is 250.</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">        order : int, optional</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">            Order of the Butterworth filter. Default is 3.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">        fs : float, optional</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">            Sampling frequency for the filter in Hz. Default is 512.</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        -------</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">            Normalized dot product values for each ROI, shape (num_rois,).</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">dot_prod</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="n">c_roi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># index of ROIs in this plane</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">bwReference</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">butterworthbpf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">[</span><span class="n">plane</span><span class="p">],</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>  <span class="c1"># filtered reference image</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="n">bwReference</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bwReference</span><span class="p">)</span>  <span class="c1"># adjust to norm for straightforward cosine angle</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="c1"># compute normalized dot product for each ROI</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="n">dot_prod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bwReference</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">roi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">roi</span><span class="p">]]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">roi</span><span class="p">])</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">c_roi_idx</span><span class="p">])</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dot_prod</span><span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        Compute Pearson correlation between filtered reference and ROI masks.</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">        Computes the Pearson correlation coefficient between each ROI mask and</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">        a Butterworth-filtered reference image within a cropped region around</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        each ROI. This is used as a feature for identifying red cells.</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">        plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="sd">            Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">        width : float, optional</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">            Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">            Default is 20.</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">        lowcut : float, optional</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">            Low cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">            Default is 12.</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">        highcut : float, optional</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">            High cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">            Default is 250.</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        order : int, optional</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">            Order of the Butterworth filter. Default is 3.</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        fs : float, optional</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">            Sampling frequency for the filter in Hz. Default is 512.</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">        -------</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">            Pearson correlation coefficients for each ROI, shape (num_rois,).</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">corr_coef</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="n">num_rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)[</span><span class="n">plane</span><span class="p">]</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="n">c_ref_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">centered_reference_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">filtPrms</span><span class="o">=</span><span class="p">(</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fs</span><span class="p">)),</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                <span class="p">(</span><span class="n">num_rois</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="n">c_mask_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centered_mask_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">num_rois</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="n">c_mask_stack</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="c1"># Measure mean and standard deviation (and number of non-nan datapoints)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="n">u_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="n">u_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">c_mask_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="n">s_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="n">s_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">c_mask_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="c1"># compute correlation coefficient and add to storage variable</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="n">corr_coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">c_ref_stack</span> <span class="o">-</span> <span class="n">u_ref</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_mask_stack</span> <span class="o">-</span> <span class="n">u_mask</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span> <span class="o">/</span> <span class="n">s_ref</span> <span class="o">/</span> <span class="n">s_mask</span><span class="p">)</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">corr_coef</span><span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="c1"># --------------------------</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="c1"># -- supporting functions --</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="c1"># --------------------------</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_centered_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numElements</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="sd">        Create a centered axis array.</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="sd">        numElements : int</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="sd">            Number of elements in the axis.</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="sd">        scale : float, optional</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="sd">            Scaling factor for the axis. Default is 1.</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">        -------</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">            Centered axis array, shape (numElements,), with values ranging from</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">            -scale*(numElements-1)/2 to scale*(numElements-1)/2.</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="k">return</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numElements</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">numElements</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getyref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yCenter</span><span class="p">):</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        Get y-axis reference coordinates relative to a center point.</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">        yCenter : float</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">            Y-coordinate of the center point in pixels.</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">        -------</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">            Y-axis coordinates in micrometers relative to yCenter, shape (ly,).</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_base_ref</span> <span class="o">-</span> <span class="n">yCenter</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getxref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xCenter</span><span class="p">):</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">        Get x-axis reference coordinates relative to a center point.</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">        xCenter : float</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">            X-coordinate of the center point in pixels.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">        -------</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">            X-axis coordinates in micrometers relative to xCenter, shape (lx,).</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_base_ref</span> <span class="o">-</span> <span class="n">xCenter</span><span class="p">)</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_roi_centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;weightedmean&quot;</span><span class="p">):</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="sd">        Get the centroid of an ROI.</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="sd">        idx : int</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">            Index of the ROI.</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">        mode : str, optional</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="sd">            Method for computing centroid. &quot;weightedmean&quot; uses pixel weights (lam),</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="sd">            &quot;median&quot; uses median pixel coordinates. Default is &quot;weightedmean&quot;.</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="sd">        -------</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">        yc : float</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">            Y-coordinate of the centroid in pixels.</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">        xc : float</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">            X-coordinate of the centroid in pixels.</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;weightedmean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>            <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>            <span class="n">xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>            <span class="n">yc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>            <span class="n">xc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="k">return</span> <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_roi_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">        Get the range (peak-to-peak) of x and y pixels for an ROI.</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">        idx : int</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">            Index of the ROI.</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">        -------</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="sd">        yr : int</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">            Range of y-pixels (peak-to-peak).</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="sd">        xr : int</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">            Range of x-pixels (peak-to-peak).</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="c1"># get range of x and y pixels for a particular ROI</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="n">yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="n">xr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="k">return</span> <span class="n">yr</span><span class="p">,</span> <span class="n">xr</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_roi_in_plane_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">        Get the index of an ROI within its own plane.</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">        idx : int</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">            Global ROI index.</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">        -------</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">        int</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">            Index of the ROI within its plane (0-indexed within that plane).</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>        <span class="c1"># return index of ROI within it&#39;s own plane</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>        <span class="k">return</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">&lt;</span> <span class="n">plane_idx</span><span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">centered_reference_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">filtPrms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">        Create a stack of reference images centered on each ROI.</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">        Returns a stack of reference images cropped around each ROI centroid</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">        within a specified width. Optionally applies a Butterworth filter to</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">        the reference images before cropping.</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">        plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">            Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">        width : float, optional</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">            Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">            Default is 15.</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="sd">        fill : float, optional</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="sd">            Value to use for background pixels outside the image bounds.</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a><span class="sd">            Should be 0.0 or np.nan. Default is 0.0.</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a><span class="sd">        filtPrms : tuple of 4 floats, optional</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="sd">            Parameters for Butterworth filter: (lowcut, highcut, order, fs).</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="sd">            If None, no filtering is applied. Default is None.</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">        -------</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="sd">            Stack of centered reference images, shape (num_rois, height, width),</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">            where height = width = 2 * round(width / um_per_pixel) + 1.</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>        <span class="n">num_pixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">))</span>  <span class="c1"># numPixels to each side around the centroid</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="n">ref_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>            <span class="n">c_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>            <span class="k">if</span> <span class="n">filtPrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>                <span class="c1"># filtered reference image</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>                <span class="n">c_reference</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">butterworthbpf</span><span class="p">(</span><span class="n">c_reference</span><span class="p">,</span> <span class="n">filtPrms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filtPrms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">filtPrms</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fs</span><span class="o">=</span><span class="n">filtPrms</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="n">idx_roi_in_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>            <span class="n">ref_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fill</span><span class="p">))</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="c1"># fill the reference stack with the reference image</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx_roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">):</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roi_centroid</span><span class="p">(</span><span class="n">idx_roi</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">)</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                <span class="n">yUse</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">yc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">))</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                <span class="n">xUse</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">))</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                <span class="n">yMissing</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ly</span> <span class="o">-</span> <span class="p">(</span><span class="n">yc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                <span class="p">)</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                <span class="n">xMissing</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span> <span class="o">-</span> <span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                <span class="p">)</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>                <span class="n">ref_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                    <span class="n">idx</span><span class="p">,</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                    <span class="n">yMissing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">yMissing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                    <span class="n">xMissing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">xMissing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">c_reference</span><span class="p">[</span><span class="n">yUse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">yUse</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xUse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">xUse</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ref_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">centered_mask_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a><span class="sd">        Create a stack of ROI masks centered on each ROI.</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">        Returns a stack of ROI masks cropped around each ROI centroid within</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">        a specified width. Mask values (lam) are placed at the appropriate</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="sd">        positions in the centered stack.</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="sd">        plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="sd">            Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="sd">        width : float, optional</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">            Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">            Default is 15.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">        fill : float, optional</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">            Value to use for background pixels outside the ROI mask.</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">            Should be 0.0 or np.nan. Default is 0.0.</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">        -------</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">            Stack of centered ROI masks, shape (num_rois, height, width),</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">            where height = width = 2 * round(width / um_per_pixel) + 1.</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>        <span class="n">num_pixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">))</span>  <span class="c1"># numPixels to each side around the centroid</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>        <span class="n">mask_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>            <span class="n">idx_roi_in_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>            <span class="n">mask_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fill</span><span class="p">))</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx_roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">):</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>                <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roi_centroid</span><span class="p">(</span><span class="n">idx_roi</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">)</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>                <span class="c1"># centered y&amp;x pixels of ROI</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>                <span class="n">cyidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx_roi</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">num_pixels</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>                <span class="n">cxidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx_roi</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">num_pixels</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>                <span class="c1"># index of pixels still within width of stack</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>                <span class="n">idx_use_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">cyidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cyidx</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cxidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cxidx</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>                <span class="n">mask_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="n">cyidx</span><span class="p">[</span><span class="n">idx_use_points</span><span class="p">],</span> <span class="n">cxidx</span><span class="p">[</span><span class="n">idx_use_points</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx_roi</span><span class="p">][</span><span class="n">idx_use_points</span><span class="p">]</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mask_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><span class="sd">        Compute full-volume ROI masks for specified planes.</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a><span class="sd">        Creates a 3D array where each ROI mask is placed at its original</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">        position in the full image plane. This is useful for visualization</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="sd">        or volume-based operations.</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a><span class="sd">        plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a><span class="sd">            Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="sd">        -------</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="sd">        np.ndarray</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a><span class="sd">            Volume array of ROI masks, shape (num_rois, ly, lx), where ly and lx</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="sd">            are the dimensions of the reference images.</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="sd">        Raises</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="sd">        ------</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="sd">        AssertionError</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a><span class="sd">            If any plane index is out of range.</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>            <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;in session: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, there are only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="si">}</span><span class="s2"> planes!&quot;</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">plane</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span> <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">]),</span> <span class="n">msg</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>        <span class="n">roi_mask_volume</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>            <span class="n">roi_mask_volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)[</span><span class="n">plane</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">)))</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>            <span class="n">idx_roi_in_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>            <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)[</span><span class="n">plane</span><span class="p">]):</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>                <span class="n">c_roi_idx</span> <span class="o">=</span> <span class="n">idx_roi_in_plane</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>                <span class="n">roi_mask_volume</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">roi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">c_roi_idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">c_roi_idx</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">c_roi_idx</span><span class="p">]</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">roi_mask_volume</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">b2session</span><span class="p">,</span> <span class="n">um_per_pixel</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.__init__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initialize RedCellProcessing object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>b2session</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Session


  
      dataclass
   (vrAnalysis.sessions.B2Session)" href="../b2session/#vrAnalysis.sessions.B2Session">B2Session</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Session object containing the session data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>um_per_pixel</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Micrometers per pixel for spatial measurements. Default is 1.3.</p>
              </div>
            </td>
            <td>
                  <code>1.3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>autoload</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, automatically load reference images and masks on initialization.
Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If redcell is not available in suite2p outputs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">b2session</span><span class="p">:</span> <span class="s2">&quot;B2Session&quot;</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">um_per_pixel</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.3</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">autoload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="p">):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    Initialize RedCellProcessing object.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    b2session : B2Session</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        The B2Session object containing the session data.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    um_per_pixel : float, optional</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        Micrometers per pixel for spatial measurements. Default is 1.3.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    autoload : bool, optional</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        If True, automatically load reference images and masks on initialization.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        Default is True.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    ------</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    AssertionError</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        If redcell is not available in suite2p outputs.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="c1"># Make sure redcell is available...</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;redcell is not an available suite2p output, so you can&#39;t do redCellProcessing.&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">assert</span> <span class="s2">&quot;redcell&quot;</span> <span class="ow">in</span> <span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">),</span> <span class="n">msg</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span> <span class="o">=</span> <span class="n">b2session</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="c1"># standard names of the features used to determine red cell criterion</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;S2P&quot;</span><span class="p">,</span> <span class="s2">&quot;dotProduct&quot;</span><span class="p">,</span> <span class="s2">&quot;pearson&quot;</span><span class="p">,</span> <span class="s2">&quot;phaseCorrelation&quot;</span><span class="p">]</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="c1"># load some critical values for easy readable access</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;planeNames&quot;</span><span class="p">))</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span> <span class="o">=</span> <span class="n">um_per_pixel</span>  <span class="c1"># store this for generating correct axes and measuring distances</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># initialize to false in case data isn&#39;t loaded</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>  <span class="c1"># prepare reference images and ROI mask data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.centered_mask_stack" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">centered_mask_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.centered_mask_stack" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Create a stack of ROI masks centered on each ROI.</p>
<p>Returns a stack of ROI masks cropped around each ROI centroid within
a specified width. Mask values (lam) are placed at the appropriate
positions in the centered stack.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plane_idx</code>
            </td>
            <td>
                  <code>int or array-like of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Plane indices to process. If None, processes all planes. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width in micrometers of the cropped region around each ROI centroid.
Default is 15.</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to use for background pixels outside the ROI mask.
Should be 0.0 or np.nan. Default is 0.0.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stack of centered ROI masks, shape (num_rois, height, width),
where height = width = 2 * round(width / um_per_pixel) + 1.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-620" name="__codelineno-0-620"></a><span class="k">def</span><span class="w"> </span><span class="nf">centered_mask_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a><span class="sd">    Create a stack of ROI masks centered on each ROI.</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">    Returns a stack of ROI masks cropped around each ROI centroid within</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">    a specified width. Mask values (lam) are placed at the appropriate</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="sd">    positions in the centered stack.</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="sd">    plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="sd">        Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="sd">    width : float, optional</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">        Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">        Default is 15.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">    fill : float, optional</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">        Value to use for background pixels outside the ROI mask.</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">        Should be 0.0 or np.nan. Default is 0.0.</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">    -------</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">        Stack of centered ROI masks, shape (num_rois, height, width),</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">        where height = width = 2 * round(width / um_per_pixel) + 1.</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>    <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="n">num_pixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">))</span>  <span class="c1"># numPixels to each side around the centroid</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>    <span class="n">mask_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>        <span class="n">idx_roi_in_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="n">mask_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fill</span><span class="p">))</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx_roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">):</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>            <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roi_centroid</span><span class="p">(</span><span class="n">idx_roi</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">)</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>            <span class="c1"># centered y&amp;x pixels of ROI</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>            <span class="n">cyidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx_roi</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">num_pixels</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>            <span class="n">cxidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx_roi</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">num_pixels</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>            <span class="c1"># index of pixels still within width of stack</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>            <span class="n">idx_use_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">cyidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cyidx</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cxidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cxidx</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>            <span class="n">mask_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="n">cyidx</span><span class="p">[</span><span class="n">idx_use_points</span><span class="p">],</span> <span class="n">cxidx</span><span class="p">[</span><span class="n">idx_use_points</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx_roi</span><span class="p">][</span><span class="n">idx_use_points</span><span class="p">]</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mask_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.centered_reference_stack" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">centered_reference_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">filtPrms</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.centered_reference_stack" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Create a stack of reference images centered on each ROI.</p>
<p>Returns a stack of reference images cropped around each ROI centroid
within a specified width. Optionally applies a Butterworth filter to
the reference images before cropping.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plane_idx</code>
            </td>
            <td>
                  <code>int or array-like of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Plane indices to process. If None, processes all planes. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width in micrometers of the cropped region around each ROI centroid.
Default is 15.</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to use for background pixels outside the image bounds.
Should be 0.0 or np.nan. Default is 0.0.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filtPrms</code>
            </td>
            <td>
                  <code>tuple of 4 floats</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters for Butterworth filter: (lowcut, highcut, order, fs).
If None, no filtering is applied. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stack of centered reference images, shape (num_rois, height, width),
where height = width = 2 * round(width / um_per_pixel) + 1.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="k">def</span><span class="w"> </span><span class="nf">centered_reference_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">filtPrms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">    Create a stack of reference images centered on each ROI.</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">    Returns a stack of reference images cropped around each ROI centroid</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">    within a specified width. Optionally applies a Butterworth filter to</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">    the reference images before cropping.</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">    plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">        Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">    width : float, optional</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">        Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">        Default is 15.</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="sd">    fill : float, optional</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="sd">        Value to use for background pixels outside the image bounds.</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a><span class="sd">        Should be 0.0 or np.nan. Default is 0.0.</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a><span class="sd">    filtPrms : tuple of 4 floats, optional</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="sd">        Parameters for Butterworth filter: (lowcut, highcut, order, fs).</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="sd">        If None, no filtering is applied. Default is None.</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">    -------</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="sd">        Stack of centered reference images, shape (num_rois, height, width),</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">        where height = width = 2 * round(width / um_per_pixel) + 1.</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>    <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>    <span class="n">num_pixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">))</span>  <span class="c1"># numPixels to each side around the centroid</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>    <span class="n">ref_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>        <span class="n">c_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>        <span class="k">if</span> <span class="n">filtPrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="c1"># filtered reference image</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>            <span class="n">c_reference</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">butterworthbpf</span><span class="p">(</span><span class="n">c_reference</span><span class="p">,</span> <span class="n">filtPrms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filtPrms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">filtPrms</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fs</span><span class="o">=</span><span class="n">filtPrms</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>        <span class="n">idx_roi_in_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>        <span class="n">ref_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fill</span><span class="p">))</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>        <span class="c1"># fill the reference stack with the reference image</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx_roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_roi_in_plane</span><span class="p">):</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roi_centroid</span><span class="p">(</span><span class="n">idx_roi</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">)</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="n">yUse</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">yc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">))</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="n">xUse</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">))</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>            <span class="n">yMissing</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ly</span> <span class="o">-</span> <span class="p">(</span><span class="n">yc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="p">)</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>            <span class="n">xMissing</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span> <span class="o">-</span> <span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="p">)</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>            <span class="n">ref_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                <span class="n">idx</span><span class="p">,</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                <span class="n">yMissing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">yMissing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                <span class="n">xMissing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">xMissing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">c_reference</span><span class="p">[</span><span class="n">yUse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">yUse</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xUse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">xUse</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ref_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.compute_corr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_corr</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.compute_corr" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Compute Pearson correlation between filtered reference and ROI masks.</p>
<p>Computes the Pearson correlation coefficient between each ROI mask and
a Butterworth-filtered reference image within a cropped region around
each ROI. This is used as a feature for identifying red cells.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plane_idx</code>
            </td>
            <td>
                  <code>int or array-like of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Plane indices to process. If None, processes all planes. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width in micrometers of the cropped region around each ROI centroid.
Default is 20.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lowcut</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Low cutoff frequency for Butterworth bandpass filter in Hz.
Default is 12.</p>
              </div>
            </td>
            <td>
                  <code>12</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>highcut</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>High cutoff frequency for Butterworth bandpass filter in Hz.
Default is 250.</p>
              </div>
            </td>
            <td>
                  <code>250</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>order</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Order of the Butterworth filter. Default is 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fs</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sampling frequency for the filter in Hz. Default is 512.</p>
              </div>
            </td>
            <td>
                  <code>512</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pearson correlation coefficients for each ROI, shape (num_rois,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">    Compute Pearson correlation between filtered reference and ROI masks.</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">    Computes the Pearson correlation coefficient between each ROI mask and</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">    a Butterworth-filtered reference image within a cropped region around</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">    each ROI. This is used as a feature for identifying red cells.</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">    plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="sd">        Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">    width : float, optional</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">        Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        Default is 20.</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">    lowcut : float, optional</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        Low cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        Default is 12.</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">    highcut : float, optional</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">        High cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        Default is 250.</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">    order : int, optional</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">        Order of the Butterworth filter. Default is 3.</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">    fs : float, optional</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        Sampling frequency for the filter in Hz. Default is 512.</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">    -------</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        Pearson correlation coefficients for each ROI, shape (num_rois,).</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="n">corr_coef</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">num_rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)[</span><span class="n">plane</span><span class="p">]</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">c_ref_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">centered_reference_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">filtPrms</span><span class="o">=</span><span class="p">(</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fs</span><span class="p">)),</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>            <span class="p">(</span><span class="n">num_rois</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">c_mask_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centered_mask_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">num_rois</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="n">c_mask_stack</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="c1"># Measure mean and standard deviation (and number of non-nan datapoints)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="n">u_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">u_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">c_mask_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="n">s_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="n">s_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">c_mask_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c_ref_stack</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="c1"># compute correlation coefficient and add to storage variable</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="n">corr_coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">c_ref_stack</span> <span class="o">-</span> <span class="n">u_ref</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_mask_stack</span> <span class="o">-</span> <span class="n">u_mask</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span> <span class="o">/</span> <span class="n">s_ref</span> <span class="o">/</span> <span class="n">s_mask</span><span class="p">)</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">corr_coef</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.compute_dot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_dot</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.compute_dot" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Compute normalized dot product between filtered reference and ROI masks.</p>
<p>Computes the dot product between each ROI mask and a Butterworth-filtered
reference image. This is used as a feature for identifying red cells.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plane_idx</code>
            </td>
            <td>
                  <code>int or array-like of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Plane indices to process. If None, processes all planes. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lowcut</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Low cutoff frequency for Butterworth bandpass filter in Hz.
Default is 12.</p>
              </div>
            </td>
            <td>
                  <code>12</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>highcut</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>High cutoff frequency for Butterworth bandpass filter in Hz.
Default is 250.</p>
              </div>
            </td>
            <td>
                  <code>250</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>order</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Order of the Butterworth filter. Default is 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fs</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sampling frequency for the filter in Hz. Default is 512.</p>
              </div>
            </td>
            <td>
                  <code>512</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Normalized dot product values for each ROI, shape (num_rois,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">    Compute normalized dot product between filtered reference and ROI masks.</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">    Computes the dot product between each ROI mask and a Butterworth-filtered</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">    reference image. This is used as a feature for identifying red cells.</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">    plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">    lowcut : float, optional</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">        Low cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">        Default is 12.</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">    highcut : float, optional</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">        High cutoff frequency for Butterworth bandpass filter in Hz.</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">        Default is 250.</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">    order : int, optional</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        Order of the Butterworth filter. Default is 3.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">    fs : float, optional</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        Sampling frequency for the filter in Hz. Default is 512.</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">    -------</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        Normalized dot product values for each ROI, shape (num_rois,).</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="n">dot_prod</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">c_roi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># index of ROIs in this plane</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="n">bwReference</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">butterworthbpf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">[</span><span class="n">plane</span><span class="p">],</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>  <span class="c1"># filtered reference image</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="n">bwReference</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bwReference</span><span class="p">)</span>  <span class="c1"># adjust to norm for straightforward cosine angle</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="c1"># compute normalized dot product for each ROI</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="n">dot_prod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bwReference</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">roi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">roi</span><span class="p">]]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">roi</span><span class="p">])</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">c_roi_idx</span><span class="p">])</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dot_prod</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.compute_volume" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_volume</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.compute_volume" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Compute full-volume ROI masks for specified planes.</p>
<p>Creates a 3D array where each ROI mask is placed at its original
position in the full image plane. This is useful for visualization
or volume-based operations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plane_idx</code>
            </td>
            <td>
                  <code>int or array-like of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Plane indices to process. If None, processes all planes. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Volume array of ROI masks, shape (num_rois, ly, lx), where ly and lx
are the dimensions of the reference images.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any plane index is out of range.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><span class="sd">    Compute full-volume ROI masks for specified planes.</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a><span class="sd">    Creates a 3D array where each ROI mask is placed at its original</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">    position in the full image plane. This is useful for visualization</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="sd">    or volume-based operations.</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a><span class="sd">    plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a><span class="sd">        Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="sd">    -------</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a><span class="sd">        Volume array of ROI masks, shape (num_rois, ly, lx), where ly and lx</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="sd">        are the dimensions of the reference images.</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="sd">    ------</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="sd">    AssertionError</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a><span class="sd">        If any plane index is out of range.</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="k">if</span> <span class="n">plane_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="p">)</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>        <span class="n">plane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_idx</span><span class="p">,)</span>  <span class="c1"># make plane_idx iterable</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;in session: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">, there are only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span><span class="si">}</span><span class="s2"> planes!&quot;</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">plane</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_planes</span> <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">]),</span> <span class="n">msg</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="n">roi_mask_volume</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">plane_idx</span><span class="p">:</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>        <span class="n">roi_mask_volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)[</span><span class="n">plane</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">)))</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>        <span class="n">idx_roi_in_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;roiPerPlane&quot;</span><span class="p">)[</span><span class="n">plane</span><span class="p">]):</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>            <span class="n">c_roi_idx</span> <span class="o">=</span> <span class="n">idx_roi_in_plane</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>            <span class="n">roi_mask_volume</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">roi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">c_roi_idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">c_roi_idx</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">c_roi_idx</span><span class="p">]</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">roi_mask_volume</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.create_centered_axis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_centered_axis</span><span class="p">(</span><span class="n">numElements</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.create_centered_axis" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Create a centered axis array.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>numElements</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of elements in the axis.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaling factor for the axis. Default is 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Centered axis array, shape (numElements,), with values ranging from
-scale<em>(numElements-1)/2 to scale</em>(numElements-1)/2.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_centered_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numElements</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="sd">    Create a centered axis array.</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="sd">    numElements : int</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="sd">        Number of elements in the axis.</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="sd">    scale : float, optional</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="sd">        Scaling factor for the axis. Default is 1.</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">    -------</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">        Centered axis array, shape (numElements,), with values ranging from</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">        -scale*(numElements-1)/2 to scale*(numElements-1)/2.</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="k">return</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numElements</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">numElements</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.cropped_phase_correlation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cropped_phase_correlation</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1000000.0</span><span class="p">,</span> <span class="n">winFunc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.cropped_phase_correlation" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Compute phase correlation of cropped masks with cropped reference images.</p>
<p>Returns the phase correlation of each ROI mask (cropped around the ROI
centroid) with the corresponding cropped reference image. This is used
as a feature for identifying red cells.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plane_idx</code>
            </td>
            <td>
                  <code>int or array-like of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Plane indices to process. If None, processes all planes. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width in micrometers of the cropped region around each ROI centroid.
Default is 40.</p>
              </div>
            </td>
            <td>
                  <code>40</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eps</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Small value added to avoid division by zero in phase correlation.
Default is 1e6.</p>
              </div>
            </td>
            <td>
                  <code>1000000.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>winFunc</code>
            </td>
            <td>
                  <code><span title="callable">callable</span> or <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window function to apply before computing phase correlation. If "hamming",
uses Hamming window. Otherwise should be a callable that takes an array
and returns a windowed array. Default is Hamming window.</p>
              </div>
            </td>
            <td>
                  <code>lambda x: <span title="numpy.hamming">hamming</span>(<span title="x.shape">shape</span>[-1])</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>refStack</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stack of cropped reference images, shape (num_rois, height, width).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>maskStack</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stack of cropped ROI masks, shape (num_rois, height, width).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>pxcStack</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stack of phase correlation maps, shape (num_rois, height, width).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>phase_corr_values</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Phase correlation values at the center of each correlation map,
shape (num_rois,). This is the feature value used for red cell identification.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The default parameters (width=40um, eps=1e6, and a Hamming window function)
were tested on a few sessions and are subjective. Manual curation and
parameter adjustment may be necessary for optimal results.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="k">def</span><span class="w"> </span><span class="nf">cropped_phase_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">winFunc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">    Compute phase correlation of cropped masks with cropped reference images.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">    Returns the phase correlation of each ROI mask (cropped around the ROI</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    centroid) with the corresponding cropped reference image. This is used</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    as a feature for identifying red cells.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">    plane_idx : int or array-like of int, optional</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        Plane indices to process. If None, processes all planes. Default is None.</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">    width : float, optional</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">        Width in micrometers of the cropped region around each ROI centroid.</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">        Default is 40.</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">    eps : float, optional</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">        Small value added to avoid division by zero in phase correlation.</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        Default is 1e6.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">    winFunc : callable or str, optional</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        Window function to apply before computing phase correlation. If &quot;hamming&quot;,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        uses Hamming window. Otherwise should be a callable that takes an array</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        and returns a windowed array. Default is Hamming window.</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    -------</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">    refStack : np.ndarray</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">        Stack of cropped reference images, shape (num_rois, height, width).</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">    maskStack : np.ndarray</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        Stack of cropped ROI masks, shape (num_rois, height, width).</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">    pxcStack : np.ndarray</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        Stack of phase correlation maps, shape (num_rois, height, width).</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">    phase_corr_values : np.ndarray</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        Phase correlation values at the center of each correlation map,</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        shape (num_rois,). This is the feature value used for red cell identification.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">    -----</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">    The default parameters (width=40um, eps=1e6, and a Hamming window function)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">    were tested on a few sessions and are subjective. Manual curation and</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    parameter adjustment may be necessary for optimal results.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">if</span> <span class="n">winFunc</span> <span class="o">==</span> <span class="s2">&quot;hamming&quot;</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">winFunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="n">refStack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centered_reference_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>  <span class="c1"># get stack of reference image centered on each ROI</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="n">maskStack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centered_mask_stack</span><span class="p">(</span><span class="n">plane_idx</span><span class="o">=</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>  <span class="c1"># get stack of mask value centered on each ROI</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="n">window</span> <span class="o">=</span> <span class="n">winFunc</span><span class="p">(</span><span class="n">refStack</span><span class="p">)</span>  <span class="c1"># create a window function</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="n">pxcStack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="p">[</span><span class="n">helpers</span><span class="o">.</span><span class="n">phaseCorrelation</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">refStack</span><span class="p">,</span> <span class="n">maskStack</span><span class="p">)]</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="p">)</span>  <span class="c1"># measure phase correlation</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">pxcCenterPixel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pxcStack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="k">return</span> <span class="n">refStack</span><span class="p">,</span> <span class="n">maskStack</span><span class="p">,</span> <span class="n">pxcStack</span><span class="p">,</span> <span class="n">pxcStack</span><span class="p">[:,</span> <span class="n">pxcCenterPixel</span><span class="p">,</span> <span class="n">pxcCenterPixel</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.get_roi_centroid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_roi_centroid</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;weightedmean&#39;</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.get_roi_centroid" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get the centroid of an ROI.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the ROI.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method for computing centroid. "weightedmean" uses pixel weights (lam),
"median" uses median pixel coordinates. Default is "weightedmean".</p>
              </div>
            </td>
            <td>
                  <code>&#39;weightedmean&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>yc</code></td>            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Y-coordinate of the centroid in pixels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>xc</code></td>            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>X-coordinate of the centroid in pixels.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_roi_centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;weightedmean&quot;</span><span class="p">):</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="sd">    Get the centroid of an ROI.</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="sd">    idx : int</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">        Index of the ROI.</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">    mode : str, optional</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="sd">        Method for computing centroid. &quot;weightedmean&quot; uses pixel weights (lam),</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="sd">        &quot;median&quot; uses median pixel coordinates. Default is &quot;weightedmean&quot;.</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="sd">    -------</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">    yc : float</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">        Y-coordinate of the centroid in pixels.</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">    xc : float</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">        X-coordinate of the centroid in pixels.</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;weightedmean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="n">xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="n">yc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="n">xc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>    <span class="k">return</span> <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.get_roi_in_plane_idx" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_roi_in_plane_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.get_roi_in_plane_idx" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get the index of an ROI within its own plane.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Global ROI index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the ROI within its plane (0-indexed within that plane).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_roi_in_plane_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">    Get the index of an ROI within its own plane.</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">    idx : int</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">        Global ROI index.</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">    -------</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">    int</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">        Index of the ROI within its plane (0-indexed within that plane).</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>    <span class="c1"># return index of ROI within it&#39;s own plane</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="n">plane_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>    <span class="k">return</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">&lt;</span> <span class="n">plane_idx</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.get_roi_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_roi_range</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.get_roi_range" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get the range (peak-to-peak) of x and y pixels for an ROI.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the ROI.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>yr</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of y-pixels (peak-to-peak).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>xr</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of x-pixels (peak-to-peak).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_roi_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">    Get the range (peak-to-peak) of x and y pixels for an ROI.</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">    idx : int</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">        Index of the ROI.</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">    -------</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="sd">    yr : int</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">        Range of y-pixels (peak-to-peak).</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="sd">    xr : int</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">        Range of x-pixels (peak-to-peak).</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="c1"># get range of x and y pixels for a particular ROI</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="n">yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="n">xr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="k">return</span> <span class="n">yr</span><span class="p">,</span> <span class="n">xr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.getxref" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">getxref</span><span class="p">(</span><span class="n">xCenter</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.getxref" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get x-axis reference coordinates relative to a center point.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>xCenter</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>X-coordinate of the center point in pixels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>X-axis coordinates in micrometers relative to xCenter, shape (lx,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="k">def</span><span class="w"> </span><span class="nf">getxref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xCenter</span><span class="p">):</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">    Get x-axis reference coordinates relative to a center point.</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">    xCenter : float</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        X-coordinate of the center point in pixels.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">    -------</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        X-axis coordinates in micrometers relative to xCenter, shape (lx,).</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_base_ref</span> <span class="o">-</span> <span class="n">xCenter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.getyref" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">getyref</span><span class="p">(</span><span class="n">yCenter</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.getyref" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get y-axis reference coordinates relative to a center point.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>yCenter</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Y-coordinate of the center point in pixels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Y-axis coordinates in micrometers relative to yCenter, shape (ly,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="k">def</span><span class="w"> </span><span class="nf">getyref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yCenter</span><span class="p">):</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">    Get y-axis reference coordinates relative to a center point.</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">    yCenter : float</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">        Y-coordinate of the center point in pixels.</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">    -------</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">    np.ndarray</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">        Y-axis coordinates in micrometers relative to yCenter, shape (ly,).</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span><span class="p">):</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_and_masks</span><span class="p">()</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_base_ref</span> <span class="o">-</span> <span class="n">yCenter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.load_reference_and_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_reference_and_masks</span><span class="p">()</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.load_reference_and_masks" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Load reference images and ROI masks from suite2p outputs.</p>
<p>Loads the mean image for channel 2 (red channel) for each plane, along
with ROI mask data (lam, ypix, xpix) and ROI plane indices. Also loads
suite2p red cell values and creates supporting variables for spatial
measurements.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If reference images do not all have the same shape.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_reference_and_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">    Load reference images and ROI masks from suite2p outputs.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    Loads the mean image for channel 2 (red channel) for each plane, along</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    with ROI mask data (lam, ypix, xpix) and ROI plane indices. Also loads</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    suite2p red cell values and creates supporting variables for spatial</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    measurements.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">    ------</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    AssertionError</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">        If reference images do not all have the same shape.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="c1"># load reference images</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;ops&quot;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="p">[</span><span class="s2">&quot;meanImg_chan2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;reference images do not all have the same shape&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">)</span> <span class="o">==</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">msg</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="c1"># load masks (lam=weight of each pixel, xpix &amp; ypix=index of each pixel in ROI mask)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">load_s2p</span><span class="p">(</span><span class="s2">&quot;stat&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;lam&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;ypix&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;xpix&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">roi_plane_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.stackPosition&quot;</span><span class="p">)[:,</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="c1"># load S2P red cell value</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">red_s2p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redS2P&quot;</span><span class="p">)</span>  <span class="c1"># (preloaded, will never change in this function)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="c1"># create supporting variables for mapping locations and axes</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">y_base_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">x_base_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">y_dist_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_centered_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">x_dist_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_centered_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_per_pixel</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="c1"># update data_loaded field</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">data_loaded</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.one_name_feature_cutoffs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">one_name_feature_cutoffs</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.one_name_feature_cutoffs" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Generate oneData name for feature cutoff parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Feature name (e.g., "S2P", "dotProduct", "pearson", "phaseCorrelation").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OneData name for the feature cutoff parameter, formatted as
"parametersRed{Name}.minMaxCutoff" where {Name} is the capitalized
feature name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="k">def</span><span class="w"> </span><span class="nf">one_name_feature_cutoffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    Generate oneData name for feature cutoff parameters.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">    name : str</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        Feature name (e.g., &quot;S2P&quot;, &quot;dotProduct&quot;, &quot;pearson&quot;, &quot;phaseCorrelation&quot;).</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">    -------</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    str</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        OneData name for the feature cutoff parameter, formatted as</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        &quot;parametersRed{Name}.minMaxCutoff&quot; where {Name} is the capitalized</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        feature name.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">return</span> <span class="s2">&quot;parameters&quot;</span> <span class="o">+</span> <span class="s2">&quot;Red&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.minMaxCutoff&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.update_from_session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_from_session</span><span class="p">(</span><span class="n">red_cell</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.update_from_session" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Update red cell cutoffs from another session.</p>
<p>Copies red cell cutoff parameters from another RedCellProcessing object
and applies them to this session.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>red_cell</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="RedCellProcessing (vrAnalysis.registration.redcell.RedCellProcessing)" href="#vrAnalysis.registration.RedCellProcessing">RedCellProcessing</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Another RedCellProcessing object to copy cutoffs from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_update</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, only allows copying from sessions with the same mouse name.
If True, allows copying from any session. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If red_cell is not a RedCellProcessing object, or if force_update is
False and the mouse names don't match.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_from_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red_cell</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">    Update red cell cutoffs from another session.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">    Copies red cell cutoff parameters from another RedCellProcessing object</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    and applies them to this session.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">    red_cell : RedCellProcessing</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">        Another RedCellProcessing object to copy cutoffs from.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">    force_update : bool, optional</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        If False, only allows copying from sessions with the same mouse name.</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        If True, allows copying from any session. Default is False.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    ------</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    AssertionError</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        If red_cell is not a RedCellProcessing object, or if force_update is</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">        False and the mouse names don&#39;t match.</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">red_cell</span><span class="p">,</span> <span class="n">RedCellProcessing</span><span class="p">),</span> <span class="s2">&quot;red_cell is not a RedCellProcessing object&quot;</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">force_update</span><span class="p">):</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="k">assert</span> <span class="p">(</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">red_cell</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">mouse_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">mouse_name</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="p">),</span> <span class="s2">&quot;session to copy from is from a different mouse, this isn&#39;t allowed without the force_update=True input&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="n">cutoffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">red_cell</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="n">red_cell</span><span class="o">.</span><span class="n">one_name_feature_cutoffs</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">update_red_idx</span><span class="p">(</span><span class="n">s2p_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dot_product_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">corr_coef_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">phase_corr_cutoff</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="vrAnalysis.registration.RedCellProcessing.update_red_idx" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_red_idx</span><span class="p">(</span><span class="n">s2p_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dot_product_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corr_coef_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_corr_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.RedCellProcessing.update_red_idx" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Update red cell index based on feature cutoff values.</p>
<p>Updates the red cell index by applying minimum and maximum cutoffs to
each feature (S2P, dot product, Pearson correlation, phase correlation).
Only features with non-NaN cutoff values are applied. The red cell index
is updated to include only ROIs that meet all specified criteria.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>s2p_cutoff</code>
            </td>
            <td>
                  <code>array-like of float, length 2</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>[min, max] cutoff values for suite2p red cell feature. NaN values
indicate the cutoff should not be applied. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dot_product_cutoff</code>
            </td>
            <td>
                  <code>array-like of float, length 2</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>[min, max] cutoff values for dot product feature. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>corr_coef_cutoff</code>
            </td>
            <td>
                  <code>array-like of float, length 2</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>[min, max] cutoff values for Pearson correlation feature.
Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_corr_cutoff</code>
            </td>
            <td>
                  <code>array-like of float, length 2</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>[min, max] cutoff values for phase correlation feature.
Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any cutoff is not a numpy array or list, or if any cutoff does
not have exactly 2 elements.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>Cutoff values are saved to oneData for future reference. The red cell
index is updated in place and saved to oneData.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/redcell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_red_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s2p_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dot_product_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corr_coef_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_corr_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    Update red cell index based on feature cutoff values.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    Updates the red cell index by applying minimum and maximum cutoffs to</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    each feature (S2P, dot product, Pearson correlation, phase correlation).</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    Only features with non-NaN cutoff values are applied. The red cell index</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    is updated to include only ROIs that meet all specified criteria.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    s2p_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        [min, max] cutoff values for suite2p red cell feature. NaN values</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        indicate the cutoff should not be applied. Default is None.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">    dot_product_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        [min, max] cutoff values for dot product feature. Default is None.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">    corr_coef_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        [min, max] cutoff values for Pearson correlation feature.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        Default is None.</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    phase_corr_cutoff : array-like of float, length 2, optional</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        [min, max] cutoff values for phase correlation feature.</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        Default is None.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">    ------</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">    ValueError</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        If any cutoff is not a numpy array or list, or if any cutoff does</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">        not have exactly 2 elements.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">    -----</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">    Cutoff values are saved to oneData for future reference. The red cell</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">    index is updated in place and saved to oneData.</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="c1"># create initial all true red cell idx</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">red_cell_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redCellIdx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="c1"># load feature values for each ROI</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">red_s2p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redS2P&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">dot_product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redDotProduct&quot;</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">corr_coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redPearson&quot;</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="n">phase_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;mpciROIs.redPhaseCorrelation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="c1"># create lists for zipping through each feature/cutoff combination</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">red_s2p</span><span class="p">,</span> <span class="n">dot_product</span><span class="p">,</span> <span class="n">corr_coef</span><span class="p">,</span> <span class="n">phase_corr</span><span class="p">]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">cutoffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s2p_cutoff</span><span class="p">,</span> <span class="n">dot_product_cutoff</span><span class="p">,</span> <span class="n">corr_coef_cutoff</span><span class="p">,</span> <span class="n">phase_corr_cutoff</span><span class="p">]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">usecutoff</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cutoffs</span><span class="p">))]</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="c1"># check validity of each cutoff and identify whether it should be used</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">usecutoff</span><span class="p">,</span> <span class="n">cutoffs</span><span class="p">):</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting a numpy array or a list for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> cutoff, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> cutoff does not have 2 elements&quot;</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">use</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="c1"># add feature cutoffs to redCellIdx (sets any to False that don&#39;t meet the cutoff)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">usecutoff</span><span class="p">,</span> <span class="n">cutoffs</span><span class="p">):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="k">if</span> <span class="n">use</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">red_cell_idx</span> <span class="o">&amp;=</span> <span class="n">feature</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="k">if</span> <span class="n">use</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">red_cell_idx</span> <span class="o">&amp;=</span> <span class="n">feature</span> <span class="o">&lt;=</span> <span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="c1"># save new red cell index to one data</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">red_cell_idx</span><span class="p">,</span> <span class="s2">&quot;mpciROIs.redCellIdx&quot;</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="c1"># save feature cutoffs to one data</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">):</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">cutoffs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_name_feature_cutoffs</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Red Cell curation choices are saved for session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">b2session</span><span class="o">.</span><span class="n">session_print</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="vrAnalysis.registration.behavior" class="doc doc-heading">
            <code>behavior</code>


<a href="#vrAnalysis.registration.behavior" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Behavior processing functions for B2Registration.</p>
<p>This module contains functions for processing behavioral data from different
versions of the vrControl software. Each function processes behavior data
to achieve the same results structure regardless of the data collection method.</p>










<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="vrAnalysis.registration.behavior.BEHAVIOR_PROCESSING" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">BEHAVIOR_PROCESSING</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">standard_behavior</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">cr_hippocannula_behavior</span><span class="p">}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#vrAnalysis.registration.behavior.BEHAVIOR_PROCESSING" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Dictionary of behavior processing functions.</p>
<p>These reflect the different versions of the vrControl software that was used
to collect the behavior data. Because the behavioral data was collected in
different ways, we need to process it differently to achieve the same results
structure.</p>
<p>Keys:</p>
<ul>
<li>1: Standard behavior processing function.</li>
<li>2: CR hippocannula behavior processing function.</li>
</ul>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="vrAnalysis.registration.behavior.cr_hippocannula_behavior" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cr_hippocannula_behavior</span><span class="p">(</span><span class="n">b2registration</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.behavior.cr_hippocannula_behavior" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process behavior data from CR hippocannula version of vrControl.</p>
<p>Extracts behavioral data from TRIAL and EXP structures, processes
timestamps, positions, rewards, and licks, and saves them to oneData format.
Aligns behavioral timestamps to the timeline using photodiode flips.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>b2registration</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Registration


  
      dataclass
   (vrAnalysis.registration.register.B2Registration)" href="#vrAnalysis.registration.B2Registration">B2Registration</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Registration object containing the session data to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Registration


  
      dataclass
   (vrAnalysis.registration.register.B2Registration)" href="#vrAnalysis.registration.B2Registration">B2Registration</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Registration object with behavior data processed and saved.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function processes behavior data from the CR hippocannula version of
vrControl. The data structure differs from the standard version, requiring
different field names and processing steps.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/behavior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="k">def</span><span class="w"> </span><span class="nf">cr_hippocannula_behavior</span><span class="p">(</span><span class="n">b2registration</span><span class="p">:</span> <span class="s2">&quot;B2Registration&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;B2Registration&quot;</span><span class="p">:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    Process behavior data from CR hippocannula version of vrControl.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    Extracts behavioral data from TRIAL and EXP structures, processes</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    timestamps, positions, rewards, and licks, and saves them to oneData format.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    Aligns behavioral timestamps to the timeline using photodiode flips.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    b2registration : B2Registration</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        The B2Registration object containing the session data to process.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    -------</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">    B2Registration</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        The B2Registration object with behavior data processed and saved.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">    -----</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    This function processes behavior data from the CR hippocannula version of</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">    vrControl. The data structure differs from the standard version, requiring</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    different field names and processing steps.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="n">trialInfo</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;TRIAL&quot;</span><span class="p">]</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="n">expInfo</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;EXP&quot;</span><span class="p">]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">numTrials</span> <span class="o">=</span> <span class="n">trialInfo</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">no</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">nonNanSamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">time</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="k">assert</span> <span class="n">numTrials</span> <span class="o">==</span> <span class="n">nonNanSamples</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;# trials </span><span class="si">{</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">no</span><span class="si">}</span><span class="s2"> isn&#39;t equal to non-nan first time samples </span><span class="si">{</span><span class="n">nonNanSamples</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">,</span> <span class="n">numTrials</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="c1"># trialInfo contains sparse matrices of size (maxTrials, maxSamples), where numTrials&lt;maxTrials and numSamples&lt;maxSamples</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">nzindex</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="n">timeStamps</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_vr_data</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">nzindex</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">roomPosition</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_vr_data</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">roomPosition</span><span class="p">),</span> <span class="n">nzindex</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="c1"># oneData with behave prefix is a (numBehavioralSamples, ) shaped array conveying information about the state of VR</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">numTimeStamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">timeStamps</span><span class="p">])</span>  <span class="c1"># list of number of behavioral timestamps in each trial</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">behaveTimeStamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">timeStamps</span><span class="p">)</span>  <span class="c1"># time stamp associated with each behavioral sample</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">behavePosition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">roomPosition</span><span class="p">)</span>  <span class="c1"># virtual position associated with each behavioral sample</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numBehaveTimestamps&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">))</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="c1"># Check shapes and sizes</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="k">assert</span> <span class="n">behaveTimeStamps</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;behaveTimeStamps is not a 1-d array!&quot;</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="k">assert</span> <span class="n">behaveTimeStamps</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">behavePosition</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;behave oneData arrays do not have the same shape!&quot;</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="c1"># oneData with trial prefix is a (numTrials,) shaped array conveying information about the state on each trial</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">trialStartFrame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">numTimeStamps</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">trialEnvironmentIndex</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">vrEnvIdx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="k">if</span> <span class="s2">&quot;vrEnvIdx&quot;</span> <span class="ow">in</span> <span class="n">trialInfo</span><span class="o">.</span><span class="n">_fieldnames</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="n">trialRoomLength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">expInfo</span><span class="o">.</span><span class="n">roomLength</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="n">trialMovementGain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">))</span>  <span class="c1"># mvmt gain always one</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">trialRewardPosition</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">trialRewPos</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="n">trialRewardTolerance</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">expInfo</span><span class="o">.</span><span class="n">rewPosTolerance</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">trialRewardAvailability</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">trialRewAvailable</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="n">rewardDelivery</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">trialRewDelivery</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="n">rewardDelivery</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rewardDelivery</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># about to be (-1), indicating no reward delivered</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">rewardDelivery</span> <span class="o">=</span> <span class="n">rewardDelivery</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># get reward delivery frame (frame within trial) first (will be -1 if no reward delivered)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="c1"># adjust frame count to behave arrays</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="n">trialRewardDelivery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="p">[</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="p">(</span><span class="n">rewardDelivery</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numTimeStamps</span><span class="p">[:</span><span class="n">trialIdx</span><span class="p">])</span> <span class="k">if</span> <span class="n">rewardDelivery</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">rewardDelivery</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">trialIdx</span><span class="p">,</span> <span class="n">rewardDelivery</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rewardDelivery</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="p">]</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="n">trialActiveLicking</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">trialActiveLicking</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="n">trialActiveStopping</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">trialActiveStopping</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="c1"># Check shapes and sizes</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">assert</span> <span class="n">trialEnvironmentIndex</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialEnvironmentIndex</span><span class="p">)</span> <span class="o">==</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="s2">&quot;numTrials&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="p">),</span> <span class="s2">&quot;trialEnvironmentIndex is not a (numTrials,) shaped array!&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="k">assert</span> <span class="p">(</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">trialStartFrame</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="o">==</span> <span class="n">trialEnvironmentIndex</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="o">==</span> <span class="n">trialRoomLength</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="o">==</span> <span class="n">trialMovementGain</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="o">==</span> <span class="n">trialRewardPosition</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="o">==</span> <span class="n">trialRewardTolerance</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="o">==</span> <span class="n">trialRewardAvailability</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="o">==</span> <span class="n">trialRewardDelivery</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="o">==</span> <span class="n">trialActiveLicking</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="o">==</span> <span class="n">trialActiveStopping</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="p">),</span> <span class="s2">&quot;trial oneData arrays do not have the same shape!&quot;</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="c1"># oneData with lick prefix is a (numLicks,) shaped array containing information about each lick during VR behavior</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="n">licks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vrd</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span> <span class="k">for</span> <span class="n">vrd</span> <span class="ow">in</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_vr_data</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">lick</span><span class="p">),</span> <span class="n">nzindex</span><span class="p">)]</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">lickFrames</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">licks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">licks</span> <span class="ow">in</span> <span class="n">licks</span><span class="p">]</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="n">lickCounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">licks</span><span class="p">[</span><span class="n">lickFrames</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">licks</span><span class="p">,</span> <span class="n">lickFrames</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">licks</span><span class="p">,</span> <span class="n">lickFrames</span><span class="p">)])</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="n">lickTrials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">tidx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">tidx</span><span class="p">,</span> <span class="n">lickFrames</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">)])</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="n">lickFrames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lickCounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="n">lickFramesRepeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">,</span> <span class="n">lickCounts</span><span class="p">)])</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="n">lickTrialsRepeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lickTrials</span><span class="p">,</span> <span class="n">lickCounts</span><span class="p">)])</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">lickCountsRepeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lickCounts</span><span class="p">,</span> <span class="n">lickCounts</span><span class="p">)])</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">lickBehaveSample</span> <span class="o">=</span> <span class="n">lickFramesRepeat</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numTimeStamps</span><span class="p">[:</span><span class="n">trialIdx</span><span class="p">])</span> <span class="k">for</span> <span class="n">trialIdx</span> <span class="ow">in</span> <span class="n">lickTrialsRepeat</span><span class="p">])</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lickBehaveSample</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">lickCounts</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="p">),</span> <span class="s2">&quot;the number of licks counted by vrBehavior is not equal to the length of the lickBehaveSample vector!&quot;</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="k">assert</span> <span class="n">lickBehaveSample</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;lickBehaveIndex is not a 1-d array!&quot;</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">assert</span> <span class="p">(</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lickBehaveSample</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="p">),</span> <span class="s2">&quot;lickBehaveSample contains index outside range of possible indices for behaveTimeStamps&quot;</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="c1"># No licks found -- create empty array</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">lickBehaveSample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="c1"># Align behavioral timestamp data to timeline -- shift each trials timestamps so that they start at the time of the first photodiode flip (which is reliably detected)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="n">trialStartOffsets</span> <span class="o">=</span> <span class="n">behaveTimeStamps</span><span class="p">[</span><span class="n">trialStartFrame</span><span class="p">]</span> <span class="o">-</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;trials.startTimes&quot;</span><span class="p">)</span>  <span class="c1"># get offset</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="n">behaveTimeStamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="p">[</span><span class="n">bts</span> <span class="o">-</span> <span class="n">trialStartOffsets</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">tidx</span><span class="p">,</span> <span class="n">bts</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">group_behave_by_trial</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">,</span> <span class="n">trialStartFrame</span><span class="p">))]</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="c1"># Save behave onedata</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">,</span> <span class="s2">&quot;positionTracking.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">behavePosition</span><span class="p">,</span> <span class="s2">&quot;positionTracking.position&quot;</span><span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="c1"># Save trial onedata</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialStartFrame</span><span class="p">,</span> <span class="s2">&quot;trials.positionTracking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialEnvironmentIndex</span><span class="p">,</span> <span class="s2">&quot;trials.environmentIndex&quot;</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRoomLength</span><span class="p">,</span> <span class="s2">&quot;trials.roomlength&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialMovementGain</span><span class="p">,</span> <span class="s2">&quot;trials.movementGain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardPosition</span><span class="p">,</span> <span class="s2">&quot;trials.rewardPosition&quot;</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardTolerance</span><span class="p">,</span> <span class="s2">&quot;trials.rewardZoneHalfwidth&quot;</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardAvailability</span><span class="p">,</span> <span class="s2">&quot;trials.rewardAvailability&quot;</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardDelivery</span><span class="p">,</span> <span class="s2">&quot;trials.rewardPositionTracking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialActiveLicking</span><span class="p">,</span> <span class="s2">&quot;trials.activeLicking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialActiveStopping</span><span class="p">,</span> <span class="s2">&quot;trials.activeStopping&quot;</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="c1"># Save lick onedata</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">lickBehaveSample</span><span class="p">,</span> <span class="s2">&quot;licksTracking.positionTracking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">return</span> <span class="n">b2registration</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vrAnalysis.registration.behavior.register_behavior" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_behavior</span><span class="p">(</span><span class="n">b2registration</span><span class="p">,</span> <span class="n">behavior_type</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.behavior.register_behavior" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Register behavior for a given behavior type.</p>
<p>This is a dispatcher function that calls the appropriate behavior processing
function based on the behavior type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>b2registration</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Registration


  
      dataclass
   (vrAnalysis.registration.register.B2Registration)" href="#vrAnalysis.registration.B2Registration">B2Registration</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Registration object containing the session data to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior_type</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The behavior type to register. Must be a key in BEHAVIOR_PROCESSING.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Registration


  
      dataclass
   (vrAnalysis.registration.register.B2Registration)" href="#vrAnalysis.registration.B2Registration">B2Registration</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Registration object with behavior registered.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If behavior_type is not supported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="see-also" open>
  <summary>See Also</summary>
  <p>BEHAVIOR_PROCESSING : Dictionary mapping behavior types to processing functions.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/behavior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="k">def</span><span class="w"> </span><span class="nf">register_behavior</span><span class="p">(</span><span class="n">b2registration</span><span class="p">:</span> <span class="s2">&quot;B2Registration&quot;</span><span class="p">,</span> <span class="n">behavior_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;B2Registration&quot;</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">    Register behavior for a given behavior type.</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">    This is a dispatcher function that calls the appropriate behavior processing</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">    function based on the behavior type.</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">    b2registration : B2Registration</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        The B2Registration object containing the session data to process.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">    behavior_type : int</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">        The behavior type to register. Must be a key in BEHAVIOR_PROCESSING.</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">    -------</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">    B2Registration</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">        The B2Registration object with behavior registered.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">    ------</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">    ValueError</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">        If behavior_type is not supported.</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">    See Also</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">    --------</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">    BEHAVIOR_PROCESSING : Dictionary mapping behavior types to processing functions.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="k">if</span> <span class="n">behavior_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BEHAVIOR_PROCESSING</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Behavior type </span><span class="si">{</span><span class="n">behavior_type</span><span class="si">}</span><span class="s2"> not supported. Supported types are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">BEHAVIOR_PROCESSING</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="k">return</span> <span class="n">BEHAVIOR_PROCESSING</span><span class="p">[</span><span class="n">behavior_type</span><span class="p">](</span><span class="n">b2registration</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vrAnalysis.registration.behavior.standard_behavior" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">standard_behavior</span><span class="p">(</span><span class="n">b2registration</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.behavior.standard_behavior" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process standard behavior data from vrControl.</p>
<p>Extracts behavioral data from trialInfo and expInfo structures, processes
timestamps, positions, rewards, and licks, and saves them to oneData format.
Aligns behavioral timestamps to the timeline using photodiode flips.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>b2registration</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Registration


  
      dataclass
   (vrAnalysis.registration.register.B2Registration)" href="#vrAnalysis.registration.B2Registration">B2Registration</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Registration object containing the session data to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="B2Registration


  
      dataclass
   (vrAnalysis.registration.register.B2Registration)" href="#vrAnalysis.registration.B2Registration">B2Registration</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The B2Registration object with behavior data processed and saved.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function processes behavior data from the standard vrControl format.
It extracts trial-level and sample-level behavioral data and aligns timestamps
to the imaging timeline.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/behavior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">standard_behavior</span><span class="p">(</span><span class="n">b2registration</span><span class="p">:</span> <span class="s2">&quot;B2Registration&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;B2Registration&quot;</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    Process standard behavior data from vrControl.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Extracts behavioral data from trialInfo and expInfo structures, processes</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    timestamps, positions, rewards, and licks, and saves them to oneData format.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Aligns behavioral timestamps to the timeline using photodiode flips.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    b2registration : B2Registration</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        The B2Registration object containing the session data to process.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    -------</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    B2Registration</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        The B2Registration object with behavior data processed and saved.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    -----</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    This function processes behavior data from the standard vrControl format.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    It extracts trial-level and sample-level behavioral data and aligns timestamps</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    to the imaging timeline.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">expInfo</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;expInfo&quot;</span><span class="p">]</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">trialInfo</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">vr_file</span><span class="p">[</span><span class="s2">&quot;trialInfo&quot;</span><span class="p">]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">num_values_per_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span><span class="o">.</span><span class="n">indptr</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">valid_trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num_values_per_trial</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">numTrials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_trials</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">valid_trials</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numTrials</span><span class="p">)),</span> <span class="s2">&quot;valid_trials is not a range from 0 to numTrials&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">,</span> <span class="n">numTrials</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="c1"># trialInfo contains sparse matrices of size (maxTrials, maxSamples), where numTrials&lt;maxTrials and numSamples&lt;maxSamples</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">nzindex</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">timeStamps</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_vr_data</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">nzindex</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">roomPosition</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_vr_data</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">roomPosition</span><span class="p">),</span> <span class="n">nzindex</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="c1"># oneData with behave prefix is a (numBehavioralSamples, ) shaped array conveying information about the state of VR</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">numTimeStamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">timeStamps</span><span class="p">])</span>  <span class="c1"># list of number of behavioral timestamps in each trial</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">behaveTimeStamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">timeStamps</span><span class="p">)</span>  <span class="c1"># time stamp associated with each behavioral sample</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">behavePosition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">roomPosition</span><span class="p">)</span>  <span class="c1"># virtual position associated with each behavioral sample</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;numBehaveTimestamps&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">))</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="c1"># Check shapes and sizes</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">assert</span> <span class="n">behaveTimeStamps</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;behaveTimeStamps is not a 1-d array!&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">assert</span> <span class="n">behaveTimeStamps</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">behavePosition</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;behave oneData arrays do not have the same shape!&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="c1"># oneData with trial prefix is a (numTrials,) shaped array conveying information about the state on each trial</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">trialStartFrame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">numTimeStamps</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">trialEnvironmentIndex</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">vrEnvIdx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">if</span> <span class="s2">&quot;vrEnvIdx&quot;</span> <span class="ow">in</span> <span class="n">trialInfo</span><span class="o">.</span><span class="n">_fieldnames</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">trialRoomLength</span> <span class="o">=</span> <span class="n">expInfo</span><span class="o">.</span><span class="n">roomLength</span><span class="p">[:</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">trialMovementGain</span> <span class="o">=</span> <span class="n">expInfo</span><span class="o">.</span><span class="n">mvmtGain</span><span class="p">[:</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;numTrials&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">trialRewardPosition</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">rewardPosition</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">trialRewardTolerance</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">rewardTolerance</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">trialRewardAvailability</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">rewardAvailable</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">rewardDelivery</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">rewardDeliveryFrame</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="p">)</span>  <span class="c1"># get reward delivery frame (frame within trial) first (will be -1 if no reward delivered)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="c1"># adjust frame count to behave arrays</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">trialRewardDelivery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="p">[</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="p">(</span><span class="n">rewardDelivery</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numTimeStamps</span><span class="p">[:</span><span class="n">trialIdx</span><span class="p">])</span> <span class="k">if</span> <span class="n">rewardDelivery</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">rewardDelivery</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">trialIdx</span><span class="p">,</span> <span class="n">rewardDelivery</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rewardDelivery</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="p">]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">trialActiveLicking</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">activeLicking</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="n">trialActiveStopping</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">activeStopping</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="c1"># Check shapes and sizes</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="k">assert</span> <span class="n">trialEnvironmentIndex</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialEnvironmentIndex</span><span class="p">)</span> <span class="o">==</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="s2">&quot;numTrials&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="p">),</span> <span class="s2">&quot;trialEnvironmentIndex is not a (numTrials,) shaped array!&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">assert</span> <span class="p">(</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">trialStartFrame</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="o">==</span> <span class="n">trialEnvironmentIndex</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="o">==</span> <span class="n">trialRoomLength</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="o">==</span> <span class="n">trialMovementGain</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="o">==</span> <span class="n">trialRewardPosition</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="o">==</span> <span class="n">trialRewardTolerance</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="o">==</span> <span class="n">trialRewardAvailability</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="o">==</span> <span class="n">trialRewardDelivery</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="o">==</span> <span class="n">trialActiveLicking</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="o">==</span> <span class="n">trialActiveStopping</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="p">),</span> <span class="s2">&quot;trial oneData arrays do not have the same shape!&quot;</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="c1"># oneData with lick prefix is a (numLicks,) shaped array containing information about each lick during VR behavior</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">licks</span> <span class="o">=</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">get_vr_data</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">convert_dense</span><span class="p">(</span><span class="n">trialInfo</span><span class="o">.</span><span class="n">lick</span><span class="p">),</span> <span class="n">nzindex</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">lickFrames</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">licks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">licks</span> <span class="ow">in</span> <span class="n">licks</span><span class="p">]</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">lickCounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">licks</span><span class="p">[</span><span class="n">lickFrames</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">licks</span><span class="p">,</span> <span class="n">lickFrames</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">licks</span><span class="p">,</span> <span class="n">lickFrames</span><span class="p">)])</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">lickTrials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">tidx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">tidx</span><span class="p">,</span> <span class="n">lickFrames</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">)])</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">lickFrames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lickCounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">lickFramesRepeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lickFrames</span><span class="p">,</span> <span class="n">lickCounts</span><span class="p">)])</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">lickTrialsRepeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lickTrials</span><span class="p">,</span> <span class="n">lickCounts</span><span class="p">)])</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">lickCountsRepeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lickCounts</span><span class="p">,</span> <span class="n">lickCounts</span><span class="p">)])</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">lickBehaveSample</span> <span class="o">=</span> <span class="n">lickFramesRepeat</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numTimeStamps</span><span class="p">[:</span><span class="n">trialIdx</span><span class="p">])</span> <span class="k">for</span> <span class="n">trialIdx</span> <span class="ow">in</span> <span class="n">lickTrialsRepeat</span><span class="p">])</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lickBehaveSample</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">lickCounts</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="p">),</span> <span class="s2">&quot;the number of licks counted by vrBehavior is not equal to the length of the lickBehaveSample vector!&quot;</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="k">assert</span> <span class="n">lickBehaveSample</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;lickBehaveIndex is not a 1-d array!&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="k">assert</span> <span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lickBehaveSample</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="p">),</span> <span class="s2">&quot;lickBehaveSample contains index outside range of possible indices for behaveTimeStamps&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="c1"># No licks found -- create empty array</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">lickBehaveSample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="c1"># Align behavioral timestamp data to timeline -- shift each trials timestamps so that they start at the time of the first photodiode flip (which is reliably detected)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">trialStartOffsets</span> <span class="o">=</span> <span class="n">behaveTimeStamps</span><span class="p">[</span><span class="n">trialStartFrame</span><span class="p">]</span> <span class="o">-</span> <span class="n">b2registration</span><span class="o">.</span><span class="n">loadone</span><span class="p">(</span><span class="s2">&quot;trials.startTimes&quot;</span><span class="p">)</span>  <span class="c1"># get offset</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">behaveTimeStamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="p">[</span><span class="n">bts</span> <span class="o">-</span> <span class="n">trialStartOffsets</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">tidx</span><span class="p">,</span> <span class="n">bts</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b2registration</span><span class="o">.</span><span class="n">group_behave_by_trial</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">,</span> <span class="n">trialStartFrame</span><span class="p">))]</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="c1"># Save behave onedata</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">behaveTimeStamps</span><span class="p">,</span> <span class="s2">&quot;positionTracking.times&quot;</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">behavePosition</span><span class="p">,</span> <span class="s2">&quot;positionTracking.position&quot;</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="c1"># Save trial onedata</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialStartFrame</span><span class="p">,</span> <span class="s2">&quot;trials.positionTracking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialEnvironmentIndex</span><span class="p">,</span> <span class="s2">&quot;trials.environmentIndex&quot;</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRoomLength</span><span class="p">,</span> <span class="s2">&quot;trials.roomlength&quot;</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialMovementGain</span><span class="p">,</span> <span class="s2">&quot;trials.movementGain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardPosition</span><span class="p">,</span> <span class="s2">&quot;trials.rewardPosition&quot;</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardTolerance</span><span class="p">,</span> <span class="s2">&quot;trials.rewardZoneHalfwidth&quot;</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardAvailability</span><span class="p">,</span> <span class="s2">&quot;trials.rewardAvailability&quot;</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialRewardDelivery</span><span class="p">,</span> <span class="s2">&quot;trials.rewardPositionTracking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialActiveLicking</span><span class="p">,</span> <span class="s2">&quot;trials.activeLicking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">trialActiveStopping</span><span class="p">,</span> <span class="s2">&quot;trials.activeStopping&quot;</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="c1"># Save lick onedata</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">b2registration</span><span class="o">.</span><span class="n">saveone</span><span class="p">(</span><span class="n">lickBehaveSample</span><span class="p">,</span> <span class="s2">&quot;licksTracking.positionTracking&quot;</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">return</span> <span class="n">b2registration</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="vrAnalysis.registration.oasis" class="doc doc-heading">
            <code>oasis</code>


<a href="#vrAnalysis.registration.oasis" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="vrAnalysis.registration.oasis.oasis_deconvolution" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">oasis_deconvolution</span><span class="p">(</span><span class="n">fcorr</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">num_processes</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></code>

<a href="#vrAnalysis.registration.oasis.oasis_deconvolution" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform oasis deconvolution on a batch of fluorescence traces.</p>
<p>Processes fluorescence traces in parallel using multiple processes to
compute deconvolved spike estimates using the OASIS algorithm.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fcorr</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fluorescence traces to process, shape (num_rois, num_frames).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>g</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The g parameter for oasis deconvolution (decay constant).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_processes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of processes to use for parallel processing.
Default is cpu_count() - 1.</p>
              </div>
            </td>
            <td>
                  <code><span title="multiprocessing.cpu_count">cpu_count</span>() - 1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>list of np.ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of deconvolved traces, one per ROI. Each trace has negative
values clipped to zero.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If fcorr is not a 2D array or if num_processes is less than 1.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the oasis package cannot be imported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>vrAnalysis/registration/oasis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">oasis_deconvolution</span><span class="p">(</span><span class="n">fcorr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Perform oasis deconvolution on a batch of fluorescence traces.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Processes fluorescence traces in parallel using multiple processes to</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    compute deconvolved spike estimates using the OASIS algorithm.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    fcorr : np.ndarray</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        The fluorescence traces to process, shape (num_rois, num_frames).</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    g : float</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        The g parameter for oasis deconvolution (decay constant).</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    num_processes : int, optional</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        The number of processes to use for parallel processing.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        Default is cpu_count() - 1.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    -------</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    list of np.ndarray</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        List of deconvolved traces, one per ROI. Each trace has negative</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        values clipped to zero.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    Raises</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    ------</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    ValueError</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        If fcorr is not a 2D array or if num_processes is less than 1.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    ImportError</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        If the oasis package cannot be imported.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">if</span> <span class="n">fcorr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fcorr must be a 2D numpy array.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_processes must be at least 1.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="c1"># Lazy import of deconvolve method from oasis to not break registration</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="c1"># if oasis_deconvolution isn&#39;t used.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">oasis.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">deconvolve</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to import deconvolve from oasis.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">raise</span> <span class="n">error</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="c1"># Create partial function with fixed parameters</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">process_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_process_fc</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">deconvolve</span><span class="o">=</span><span class="n">deconvolve</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">process_func</span><span class="p">,</span> <span class="n">fcorr</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>